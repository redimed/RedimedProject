/*!
 *  opentok-angular (https://github.com/aullman/OpenTok-Angular)
 *  
 *  Angular module for OpenTok
 *
 *  @Author: Adam Ullman (http://github.com/aullman)
 *  @Copyright (c) 2014 Adam Ullman
 *  @License: Released under the MIT license (http://opensource.org/licenses/MIT)
**/
if(!window.TB)throw new Error("You must include the TB library before the TB_Angular library");var OpenTokAngular=angular.module("opentok",[]).factory("TB",function(){return TB}).factory("OTReady",["$document",function(e){var t=!1;return e.context.addEventListener("deviceReady",function(){t=!0}),function(n){t?n():e.context.addEventListener("deviceReady",n)}}]).factory("OTSession",["TB","$rootScope","OTReady",function(e,t,n){var i={streams:[],publishers:[],init:function(s,r,o,u){n(function(){i.session=e.initSession(s,r),i.session.on({sessionConnected:function(){i.publishers.forEach(function(e){i.session.publish(e)})},streamCreated:function(e){t.$apply(function(){i.streams.push(e.stream)})},streamDestroyed:function(e){t.$apply(function(){i.streams.splice(i.streams.indexOf(e.stream),1)})},sessionDisconnected:function(){t.$apply(function(){i.streams.splice(0,i.streams.length)})}}),u&&u(null,i.session),i.session.connect(o)})}};return i}]).directive("otLayout",["$window","$parse","TB",function(e,t,n){return{restrict:"E",link:function(i,s,r){var o=t(r.props)(),u=n.initLayoutContainer(s[0],o);i.$watch(function(){return s.children().length},function(){u.layout(),setTimeout(function(){n.updateViews()},100)}),e.addEventListener("resize",u.layout),i.$on("otLayout",function(){u.layout(),setTimeout(function(){n.updateViews()},100)})}}}]).directive("otPublisher",["$document","$window","OTSession",function(e,t,n){return{restrict:"E",scope:{props:"&"},link:function(e,t,i){document.addEventListener("deviceReady",function(){var s=e.props()||{};s.width=s.width?s.width:angular.element(t).css("width"),s.height=s.height?s.height:angular.element(t).css("height");var r=angular.element(t).children();t[0].getAttribute("id")||t[0].setAttribute("id","OTPublisher"),e.publisher=TB.initPublisher(i.apikey||n.session.apiKey,t[0].getAttribute("id"),s,function(t){t&&e.$emit("otPublisherError",t,e.publisher)}),angular.element(t).append(r),setTimeout(function(){e.$emit("otLayout")},1e3),n.session&&(n.session.connected||n.session.isConnected&&n.session.isConnected())&&n.session.publish(e.publisher,function(t){t&&e.$emit("otPublisherError",t,e.publisher)}),n.publishers.push(e.publisher)}),e.$on("$destroy",function(){e.session&&e.session.unpublish(e.publisher),e.publisher.destroy(),n.publishers=n.publishers.filter(function(t){return t!==e.publisher}),e.publisher=null})}}}]).directive("otSubscriber",["OTSession",function(e){return{restrict:"E",scope:{stream:"=",props:"&"},link:function(t,n){var i=t.stream,s=t.props()||{};s.width=s.width?s.width:angular.element(n).css("width"),s.height=s.height?s.height:angular.element(n).css("height");var r=angular.element(n).children();n[0].setAttribute("id",i.streamId);var o=e.session.subscribe(i,n[0].getAttribute("id"),s,function(e){e&&t.$emit("otSubscriberError",e,o)});setTimeout(function(){t.$emit("otLayout")},1e3),angular.element(n).append(r),t.$on("$destroy",function(){})}}}]);