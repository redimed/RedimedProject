angular.module("app.loggedIn.appointment",["app.loggedIn.appointment.include"]).config(function($stateProvider){$stateProvider.state("loggedIn.appointment",{url:"/appointment",templateUrl:"modules/appointment/views/index.html",controller:"AppointmentController"}).state("loggedIn.appointment_doctor",{url:"/appointment/doctor/:doctorId",templateUrl:"modules/appointment/views/doctor/index.html",controller:"AppointmentDoctorController"})}),angular.module("app.loggedIn.appointment.include",["app.loggedIn.appointment.models","app.loggedIn.appointment.controllers.index","app.loggedIn.appointment.controllers.detail","app.loggedIn.appointment.controllers.doctor","app.loggedIn.appointment.directives.calendar","app.loggedIn.appointment.directives.add"]),angular.module("app.loggedIn.appointment.models",[]).factory("AppointmentModel",function(Restangular){var mainModel={},mainApi=Restangular.all("api/meditek/v1/appointment");return mainModel.byDoctor=function(data){var instanceApi=mainApi.all("byDoctor");return instanceApi.post({data:data})},mainModel.add=function(data){var instanceApi=mainApi.all("add");return instanceApi.post({data:data})},mainModel.load=function(data){var instanceApi=mainApi.all("load");return instanceApi.post({data:data})},mainModel.detailLoad=function(data){var instanceApi=mainApi.all("detailLoad");return instanceApi.post({data:data})},mainModel.alertCenter=function(data){var instanceApi=mainApi.all("alertCenter");return instanceApi.post({data:data})},mainModel.alertCenterConsultation=function(data){var instanceApi=mainApi.all("alertCenterConsultation");return instanceApi.post({data:data})},mainModel.alertSiteCenter=function(data){var instanceApi=mainApi.all("alertSiteCenter");return instanceApi.post({data:data})},mainModel.one=function(data){var instanceApi=mainApi.all("one");return instanceApi.post({data:data})},mainModel.getServiceColor=function(data){var instanceApi=mainApi.all("getServiceColor");return instanceApi.post({data:data})},mainModel.getOneApptPatient=function(data){var instanceApi=mainApi.all("getOneApptPatient");return instanceApi.post({data:data})},mainModel.changeService=function(data){var instanceApi=mainApi.all("changeService");return instanceApi.post({data:data})},mainModel.changeStatus=function(data){var instanceApi=mainApi.all("changeStatus");return instanceApi.post({data:data})},mainModel.ApptG=function(data){var instanceApi=mainApi.all("Getappt");return instanceApi.post({data:data})},mainModel.PostCheck=function(data){var instanceApi=mainApi.all("postcheck");return instanceApi.post({data:data})},mainModel.PostUser=function(data){var instanceApi=mainApi.all("postuser");return instanceApi.post({data:data})},mainModel}),angular.module("app.loggedIn.appointment.controllers.index",[]).controller("AppointmentController",function($scope,$state){}),angular.module("app.loggedIn.appointment.controllers.detail",[]).controller("AppointmentDetailController",function($scope,$state,$stateParams,PatientModel){var load=function(){PatientModel.byid({Patient_id:$stateParams.patientId}).then(function(response){$scope.patient.item=response.data},function(error){})};$scope.patient={load:function(){load()},item:null},$scope.patient.load()}),angular.module("app.loggedIn.appointment.controllers.doctor",[]).controller("AppointmentDoctorController",function($scope,$state,$timeout,$stateParams,$modal,toastr,$cookieStore,OutreferralModel,AppointmentModel,mdtRedimedsitesService,mdtDeptService,ConfigService){var loadSite=function(){mdtRedimedsitesService.list().then(function(response){$scope.site.list=response.data},function(error){})},loadClinical=function(){mdtDeptService.listAll().then(function(response){$scope.clinicalDept.list=response.data},function(error){})};$scope.goToOtherDoctor=function(doctor){$cookieStore.put("appointment",$scope.appointment.pre),$scope.appointment.load({site_id:data.site_id,datepicker:$scope.appointment.pre.datepicker,doctor_id:doctor.DOCTOR_ID,clinical_dept_id:$scope.appointment.pre.clinical_dept_id}),$scope.appointment.pre.doctor_id=doctor.DOCTOR_ID},$scope.loadAppointment=function(){$scope.appointment.load({site_id:data.site_id,datepicker:$scope.appointment.pre.datepicker,doctor_id:$scope.appointment.pre.doctor_id,clinical_dept_id:$scope.appointment.pre.clinical_dept_id})},$scope.dialogWaitingListAdd=function(col){angular.element("#popupMenu").css({display:"none"});$modal.open({templateUrl:"waitingListAdd",controller:function($scope,$modalInstance){$scope.success=!1,$timeout(function(){$scope.doctor_id=col.DOCTOR_ID},200),$scope.$watch("success",function(success){success&&$modalInstance.close("success")})},size:"lg",resolve:{col:function(){return col}}})},angular.element("#appointment").on("click",function(){angular.element("#popupMenu").css({display:"none"})}),$scope.goToAppDetail=function(list,patient){$state.go("loggedIn.patient.appointment",{cal_id:list.CAL_ID,patient_id:patient.Patient_id})},$scope.rightAdd=function(app,col){angular.element("#popupMenu").css({display:"none"}),$scope.dialogAppointmentAdd(app,col)},$scope.onRightClick=function($event,app,col){angular.element("#popupMenu").css({display:"block",top:$event.pageY-68,left:$event.pageX-20}),$scope.appointment.selectedAppointment=angular.copy(app),$scope.appointment.selectedCol=angular.copy(col)},$scope.dialogAppointmentAdd=function(app,col){var modalInstance=$modal.open({templateUrl:"appointmentAdd",controller:function($scope,$modalInstance,app,options){$scope.appointment={app:app,col:col},$scope.options=options,$scope.params={permission:{create:!0,edit:!1}},$scope.patient=null,$scope.$watch("patient",function(patient){null!==patient&&$modalInstance.close(patient)})},size:"lg",resolve:{app:function(){return app},col:function(){return col},options:function(){return $scope.options}}});modalInstance.result.then(function(patient){if(patient){$scope.appointment.load({site_id:data.site_id,datepicker:data.datepicker,doctor_id:$stateParams.doctorId}),toastr.success("Added Successfully");var modalInstance=$modal.open({templateUrl:"notifyClaim",controller:function($scope,$modalInstance,new_patient,ClaimModel){$scope.selectClaim=function(){$modal.open({templateUrl:"claimSelect",controller:function($scope,$modalInstance,new_patient,col,toastr){var clickRow=function(row){var postData={Patient_id:new_patient.Patient_id,CAL_ID:col.CAL_ID,Claim_id:row.Claim_id};$modalInstance.close("success"),ClaimModel.addPatient(postData).then(function(response){toastr.success("You have choose claim")},function(error){})};$scope.claim={limit:10,reload:!1,Patient_id:new_patient.Patient_id,CAL_ID:col.CAL_ID,addSuccess:!1,clickRow:function(row){clickRow(row)}},$scope.$watch("claim.addSuccess",function(addSuccess){addSuccess&&$modalInstance.close("success")})},size:"lg",resolve:{new_patient:function(){return new_patient},col:function(){return col}}}).result.then(function(success){"success"===success&&$modalInstance.close("cancel")})},$scope.addClaim=function(){$modal.open({templateUrl:"claimAdd",controller:function($scope,$modalInstance,new_patient,col,toastr){$scope.claim={Patient_id:new_patient.Patient_id,CAL_ID:col.CAL_ID,success:!1},$scope.$watch("claim.success",function(success){success&&(toastr.success("You have choose claim"),$modalInstance.close("success"))})},size:"lg",resolve:{new_patient:function(){return new_patient},col:function(){return col}}}).result.then(function(success){"success"===success&&$modalInstance.close("cancel")})},$scope.cancel=function(){$modalInstance.close("cancel")}},size:"sm",backdrop:"static",keyboard:!1,resolve:{new_patient:function(){return patient}}});modalInstance.result.then(function(result){"cancel"===result&&col.IS_REFERRAL&&$modal.open({templateUrl:"notifyReferral",controller:function($scope,$modalInstance,new_patient){$scope.cancel=function(){$modalInstance.dismiss("cancel")},$scope.selectReferral=function(){$modal.open({templateUrl:"referralSelect",controller:function($scope,$modalInstance,new_patient,col,OutreferralModel){$scope.patientId=new_patient.Patient_id,$scope.reload=!1,$scope.calId=col.CAL_ID,$scope.doctorId=col.DOCTOR_ID,$scope.limit=10,$scope.addSuccess=!1,$timeout(function(){$scope.calId=col.CAL_ID},600),$scope.$watch("addSuccess",function(addSuccess){addSuccess&&$modalInstance.close("success")}),$scope.clickRow=function(row){var postData={CAL_ID:$scope.calId,outreferral_id:row.id,patient_id:$scope.patientId,isEnable:1};OutreferralModel.select(postData).then(function(response){toastr.success("You have choose Referral"),$modalInstance.close("success")},function(error){})}},size:"lg",resolve:{new_patient:function(){return new_patient},col:function(){return col}}}).result.then(function(result){"success"===result&&($modalInstance.dismiss("cancel"),scope.alertCenter.load())})},$scope.addReferral=function(){$modal.open({templateUrl:"referralAdd",controller:function($scope,$modalInstance,new_patient,col){$scope.patientId=new_patient.Patient_id,$scope.calId=col.CAL_ID,$scope.success=!1,$timeout(function(){$scope.doctorId=col.DOCTOR_ID},600),$scope.$watch("success",function(success){success&&(toastr.success("You have choose Referral"),$modalInstance.close("success"))})},size:"lg",resolve:{new_patient:function(){return new_patient},col:function(){return col}}}).result.then(function(result){"success"===result&&($modalInstance.dismiss("cancel"),scope.alertCenter.load())})}},size:"sm",backdrop:"static",keyboard:!1,resolve:{new_patient:function(){return patient}}})})}})};var load=function(option){$scope.appointment.list=[],option.datepicker=ConfigService.convertToDB(option.datepicker),AppointmentModel.detailLoad(option).then(function(response){$scope.appointment.doctors=response.doctors,_.forEach(response.data,function(data){var flagTheme=-1,flagPatient=-1,i=0;if(_.forEach($scope.appointment.list,function(list){if(list.FROM_TIME===data.FROM_TIME){if(list.cal===data.CAL_ID)return void(flagPatient=i);flagTheme=i}i++}),data.Patient_id&&-1===flagPatient&&(flagPatient=1e3),-1!==flagPatient)if(1e3!==flagPatient)$scope.appointment.list[flagPatient].cal=data.CAL_ID,$scope.appointment.list[flagPatient].CAL_ID=data.CAL_ID,$scope.appointment.list[flagPatient].patients.push({Patient_id:data.Patient_id,First_name:data.First_name,Sur_name:data.Sur_name,outreferral:data.outreferral,DOCTOR_ID:data.DOCTOR_ID,CAL_ID:data.CAL_ID}),$scope.appointment.list[flagPatient].PATIENTS="ok";else{var temp_index=0,flagIndex=!1;if(_.forEach($scope.appointment.list,function(list){return data.FROM_TIME===list.FROM_TIME?"###"===list.PATIENTS?($scope.appointment.list[temp_index].cal=data.CAL_ID,$scope.appointment.list[temp_index].CAL_ID=data.CAL_ID,$scope.appointment.list[temp_index].SERVICE_COLOR=data.SERVICE_COLOR,$scope.appointment.list[temp_index].patients=[],$scope.appointment.list[temp_index].patients.push({Patient_id:data.Patient_id,First_name:data.First_name,Sur_name:data.Sur_name,Outreferral:data.outreferral,CAL_ID:data.CAL_ID}),$scope.appointment.list[temp_index].PATIENTS="ok",$scope.appointment.list[temp_index].IS_REFERRAL=data.IS_REFERRAL,void(flagIndex=!0)):($scope.appointment.list[temp_index].cal=data.CAL_ID,$scope.appointment.list[temp_index].CAL_ID=data.CAL_ID,$scope.appointment.list[temp_index].patients.push({Patient_id:data.Patient_id,First_name:data.First_name,Sur_name:data.Sur_name,Outreferral:data.outreferral,CAL_ID:data.CAL_ID}),$scope.appointment.list[temp_index].PATIENTS="ok",void(flagIndex=!0)):void temp_index++}),!flagIndex){var doctor={SERVICE_ID:data.SERVICE_ID,CAL_ID:data.CAL_ID,IS_REFERRAL:data.IS_REFERRAL,SERVICE_COLOR:data.SERVICE_COLOR,PATIENTS:"MESS_SYS_010",patients:[],CLINICAL_DEPT_ID:data.CLINICAL_DEPT_ID};doctor.patients.push({DOCTOR_ID:$stateParams.doctorId,Patient_id:data.Patient_id,First_name:data.First_name,Sur_name:data.Sur_name,Outreferral:data.outreferral,CAL_ID:data.CAL_ID}),doctor.PATIENTS="ok",doctor.cal=data.CAL_ID,doctor.FROM_TIME=data.FROM_TIME,doctor.TO_TIME=data.TO_TIME,$scope.appointment.list.push(doctor)}}else if(-1!==flagTheme)$scope.appointment.list[flagTheme].patients=[],$scope.appointment.list[flagTheme].cal=data.CAL_ID,$scope.appointment.list[flagTheme].CAL_ID=data.CAL_ID,null!==data.Patient_id&&$scope.appointment.list[flagTheme].patients.push({Patient_id:data.Patient_id,First_name:data.First_name,Sur_name:data.Sur_name,Outreferral:data.outreferral,CAL_ID:data.CAL_ID}),$scope.appointment.list[flagTheme].PATIENTS="MESS_SYS_010",$scope.appointment.list[flagTheme].SERVICE_ID=data.SERVICE_ID,$scope.appointment.list[flagTheme].CAL_ID=data.CAL_ID,$scope.appointment.list[flagTheme].SERVICE_COLOR=data.SERVICE_COLOR,$scope.appointment.list[flagTheme].IS_REFERRAL=data.IS_REFERRAL,$scope.appointment.list[flagTheme].CLINICAL_DEPT_ID=data.CLINICAL_DEPT_ID,$scope.appointment.list[flagTheme].patients.length>0&&($scope.appointment.list[flagTheme].PATIENTS="ok");else{var doctor={SERVICE_ID:data.SERVICE_ID,CAL_ID:data.CAL_ID,IS_REFERRAL:data.IS_REFERRAL,SERVICE_COLOR:data.SERVICE_COLOR,PATIENTS:"MESS_SYS_010",patients:[],CLINICAL_DEPT_ID:data.CLINICAL_DEPT_ID};doctor.patients.push({DOCTOR_ID:$stateParams.doctorId,Patient_id:data.Patient_id,First_name:data.First_name,Sur_name:data.Sur_name,Outreferral:data.outreferral,CAL_ID:data.CAL_ID}),doctor.cal=data.CAL_ID,doctor.FROM_TIME=data.FROM_TIME,doctor.TO_TIME=data.TO_TIME,$scope.appointment.list.push(doctor)}})})};if($scope.site={list:[]},$scope.clinicalDept={list:[]},$scope.appointment={pre:{doctor_id:null,name:null,datepicker:null,site_id:null,clinical_dept_id:null},list:[],doctors:[],load:function(option){load(option)}},$cookieStore.get("appointment")){var data=$cookieStore.get("appointment");$scope.appointment.pre.datepicker=data.datepicker,$scope.appointment.pre.doctor_id=$stateParams.doctorId,$scope.appointment.pre.clinical_dept_id=data.clinical_dept_id,$scope.appointment.pre.site_id=data.site_id,OutreferralModel.DotorFromUserId($stateParams.doctorId).then(function(response){$scope.appointment.pre.name=response.data[0].NAME},function(error){}),$scope.appointment.load({site_id:data.site_id,datepicker:data.datepicker,doctor_id:$stateParams.doctorId,clinical_dept_id:data.clinical_dept_id}),loadSite(),loadClinical()}}),angular.module("app.loggedIn.appointment.directives.calendar",[]).directive("appointmentCalendar",function($modal,$timeout,$state,$cookieStore,$modal,toastr,AppointmentModel,mdtRedimedsitesService,mdtDeptService,ConfigService){return{restrict:"EA",templateUrl:"modules/appointment/directives/templates/calendar.html",scope:{options:"=",search:"="},link:function(scope,elem,attrs){var user_id=$cookieStore.get("userInfo").id;scope.arrayAppid=[],scope.oldColor=[],scope.isKeyPressed=function($event){if(e=event||window.event,e.altKey){var id=$(event.target).find(".appid").text(),patient_name=$(event.target).find(".patient_name").text();if(id>0){for(var count=0,i=0;i<scope.arrayAppid.length;i++)scope.arrayAppid[i].CAL_ID==id&&count++;if(0==count){postData={CAL_ID:id},AppointmentModel.getOneApptPatient(postData).then(function(response){if(-1==response.data){var object={CAL_ID:id};scope.arrayAppid.push(object)}else{var object={CAL_ID:id,patient_name:patient_name,appt_status:response.data.appt_status};scope.arrayAppid.push(object)}});var objectColor={CAL_ID:id,color_old:event.target.style.backgroundColor};scope.oldColor.push(objectColor),console.log(objectColor),event.target.style.backgroundColor="rgb(199, 197, 196)"}}}},scope.rightClickChangeColor=function($event){if(e=event||window.event,e.altKey)for(var id=$(event.target).find(".appid").text(),i=0;i<scope.arrayAppid.length;i++)if(id==scope.arrayAppid[i].CAL_ID)for(var j=0;j<scope.oldColor.length;j++)id==scope.oldColor[j].CAL_ID&&(event.target.style.backgroundColor=scope.oldColor[j].color_old,scope.oldColor.splice(j,1)),scope.arrayAppid.splice(i,1)},scope.changeService=function(SERVICE_ID){for(var postData=[],i=0;i<scope.arrayAppid.length;i++)object={SERVICE_ID:SERVICE_ID,CAL_ID:scope.arrayAppid[i].CAL_ID},postData.push(object);AppointmentModel.changeService(postData).then(function(response){scope.arrayAppid=[],scope.appointment.load(),scope.alertCenter.load()})},scope.isshiftRight=function($event){angular.element("#changeStatus").css({display:"none"}),e=event||window.event,1==e.ctrlKey&&angular.element("#calMenu").css({display:"block",top:$event.pageY-68,left:$event.pageX-20})},scope.changeStatusFor=function(status){for(var i=0;i<scope.arrayAppid.length;i++)postData={STATUS:status,CAL_ID:scope.arrayAppid[i].CAL_ID},AppointmentModel.changeStatus(postData).then(function(response){},function(error){})},scope.cancelCalMenu=function($event){angular.element("#calMenu").css({display:"none"}),scope.arrayAppid=[],scope.appointment.load(),scope.alertCenter.load()},scope.changeStatus=function(status){setTimeout(scope.changeStatusFor(status),2e3),toastr.success("Changes Appointment Status Successfully"),angular.element("#changeStatus").css({display:"none"}),scope.arrayAppid=[],scope.appointment.load(),scope.alertCenter.load()},scope.showChangeStatus=function($event){angular.element("#calMenu").css({display:"none"}),angular.element("#changeStatus").css({display:"block",top:$event.pageY-68,left:$event.pageX-20})},scope.cancel=function($event){angular.element("#changeStatus").css({display:"none"}),angular.element("#calMenu").css({display:"block"})},angular.element("#appointment").on("click",function(){angular.element("#popupMenu").css({display:"none"}),angular.element("#calMenu").css({display:"none"}),angular.element("#changeStatus").css({display:"none"})}),scope.servicedata={},scope.getServiceColor=function(){AppointmentModel.getServiceColor("data").then(function(response){scope.servicedata=response.data},function(error){})},scope.getServiceColor(),scope.addPatient=function(){$modal.open({templateUrl:"addPatient",controller:function($scope,$modalInstance,toastr,options){$scope.patientAddForm={params:{permission:{edit:!1,create:!0}}},$scope.options=options,$scope.$watch("onsuccess",function(success){success&&$modalInstance.close("success")})},size:"lg",resolve:{options:function(){return scope.options}}})},scope.goToCalendarDetail=function(doctor){$cookieStore.put("appointment",scope.appointment.search),$state.go("loggedIn.appointment_doctor",{doctorId:doctor.DOCTOR_ID})},scope.extendMinutes=function(hour,minute){hour=scope.convertToSeconds(hour);var seconds=hour+60*minute,sec_num=parseInt(seconds,10),hours=Math.floor(sec_num/3600),minutes=Math.floor((sec_num-3600*hours)/60);10>hours&&(hours="0"+hours),10>minutes&&(minutes="0"+minutes);var time=hours+":"+minutes;return time},scope.convertToSeconds=function(time){var hour=parseInt(time.substring(0,2)),minute=parseInt(time.substring(3));return 3600*hour+60*minute},scope.differentTimeHours=function(hourOne,hourSecond){return 0!==hourSecond?(hourOne=scope.convertToSeconds(hourOne),hourSecond=scope.convertToSeconds(hourSecond),(hourSecond-hourOne)/60):0},scope.showDropdown=function(patient,col){$modal.open({templateUrl:"notifyAlert",controller:function($scope,patient,AlertModel,OutreferralModel){var postData={Patient_id:patient.Patient_id,CAL_ID:col.CAL_ID,limit:20,offset:0,Creation_date:"desc",name:"",description:""};$scope.alert={list:[]},$scope.outreferral={name:"It has Referral"};var refPostData={CAL_ID:col.CAL_ID,patient_id:patient.Patient_id};OutreferralModel.checkPatientCalendar(refPostData).then(function(response){0===response.data&&($scope.outreferral.name=1===response.service.IS_REFERRAL?"There is no referral":"This slot does not need referral")}),AlertModel.listFollowPatient(postData).then(function(response){$scope.alert.list=response.data},function(error){})},resolve:{patient:function(){return patient}}})},scope.goToAppDetail=function(CAL_ID,Patient_id){$state.go("loggedIn.patient.consult",{cal_id:CAL_ID,patient_id:Patient_id}),$cookieStore.put("appointment",scope.appointment.search)};var search={datepicker:moment().format("DD/MM/YYYY"),site_id:1,clinical_dept_id:""},loadSite=function(){mdtRedimedsitesService.list().then(function(response){scope.site.list=response.data},function(error){})},loadClinical=function(){mdtDeptService.listAll().then(function(response){scope.clinicalDept.list=response.data},function(error){})},load=function(){var postData=angular.copy(scope.appointment.search);postData.datepicker=ConfigService.convertToDB(postData.datepicker),scope.appointment.list=[],scope.alertCenter.load(),AppointmentModel.load(postData).then(function(response){scope.doctor.headers=response.doctors;var doctor_array_temp=[];_.forEach(response.doctors,function(doctor){doctor_array_temp.push({DOCTOR_ID:doctor.DOCTOR_ID,left:0})});var min_calendar=9999;_.forEach(response.data,function(data){var flagTheme=-1,flagPatient=-1,i=0;if(_.forEach(scope.appointment.list,function(list){list.FROM_TIME===data.FROM_TIME&&_.forEach(list.cals,function(cal){return cal===data.CAL_ID?void(flagPatient=i):void(flagTheme=i)}),i++}),data.Patient_id&&-1===flagPatient&&(flagPatient=1e3),-1!==flagPatient)if(1e3!==flagPatient){var doctor_row=0;scope.appointment.list[flagPatient].cals.push(data.CAL_ID),_.forEach(response.doctors,function(doctor){return doctor.DOCTOR_ID===data.DOCTOR_ID?(scope.appointment.list[flagPatient].doctors[doctor_row].patients.push({Patient_id:data.Patient_id,First_name:data.First_name,Sur_name:data.Sur_name,outreferral:data.outreferral,DOCTOR_ID:data.DOCTOR_ID}),void(scope.appointment.list[flagPatient].doctors[doctor_row].PATIENTS="ok")):void doctor_row++})}else{var temp_index=0,flagIndex=!1;if(_.forEach(scope.appointment.list,function(list){data.FROM_TIME===list.FROM_TIME&&_.forEach(list.doctors,function(doc){if(doc.DOCTOR_ID===data.DOCTOR_ID){if("###"===doc.PATIENTS){var doctor_row=0;return scope.appointment.list[temp_index].cals.push(data.CAL_ID),_.forEach(response.doctors,function(doctor){return doctor.DOCTOR_ID===data.DOCTOR_ID?(scope.appointment.list[temp_index].doctors[doctor_row].CAL_ID=data.CAL_ID,scope.appointment.list[temp_index].doctors[doctor_row].SERVICE_COLOR=data.SERVICE_COLOR,scope.appointment.list[temp_index].doctors[doctor_row].patients=[],scope.appointment.list[temp_index].doctors[doctor_row].patients.push({Patient_id:data.Patient_id,First_name:data.First_name,Sur_name:data.Sur_name,Outreferral:data.outreferral}),scope.appointment.list[temp_index].doctors[doctor_row].PATIENTS="ok",scope.appointment.list[temp_index].doctors[doctor_row].IS_REFERRAL=data.IS_REFERRAL,void(scope.appointment.list[temp_index].doctors[doctor_row].IS_BOOKABLE=data.IS_BOOKABLE)):void doctor_row++}),void(flagIndex=!0)}var doctor_row=0;return scope.appointment.list[temp_index].cals.push(data.CAL_ID),_.forEach(response.doctors,function(doctor){return doctor.DOCTOR_ID===data.DOCTOR_ID?(scope.appointment.list[temp_index].doctors[doctor_row].patients.push({Patient_id:data.Patient_id,First_name:data.First_name,Sur_name:data.Sur_name,Outreferral:data.outreferral}),void(scope.appointment.list[temp_index].doctors[doctor_row].PATIENTS="ok")):void doctor_row++}),void(flagIndex=!0)}}),temp_index++}),!flagIndex){var doctors=[];_.forEach(response.doctors,function(doctor){doctors.push(doctor.DOCTOR_ID===data.DOCTOR_ID?{DOCTOR_ID:doctor.DOCTOR_ID,DOCTOR_NAME:doctor.NAME,SERVICE_ID:data.SERVICE_ID,CAL_ID:data.CAL_ID,IS_REFERRAL:data.IS_REFERRAL,IS_BOOKABLE:data.IS_BOOKABLE,SERVICE_COLOR:data.SERVICE_COLOR,PATIENTS:"MESS_SYS_010",patients:[],CLINICAL_DEPT_ID:data.CLINICAL_DEPT_ID}:{DOCTOR_ID:doctor.DOCTOR_ID,DOCTOR_NAME:doctor.NAME,PATIENTS:"###"})});var doctor_row=0;_.forEach(doctors,function(doctor){doctor.DOCTOR_ID===data.DOCTOR_ID&&(doctors[doctor_row].patients.push({Patient_id:data.Patient_id,First_name:data.First_name,Sur_name:data.Sur_name,Outreferral:data.outreferral}),doctors[doctor_row].PATIENTS="ok"),doctor_row++});var cal=[];cal.push(data.CAL_ID);var object={FROM_TIME:data.FROM_TIME,TO_TIME:data.TO_TIME,cals:cal,doctors:doctors};scope.appointment.list.push(object)}}else if(-1!==flagTheme){var doctor_row=0;_.forEach(scope.appointment.list[flagTheme].doctors,function(doctor){return doctor.DOCTOR_ID===data.DOCTOR_ID?(scope.appointment.list[flagTheme].doctors[doctor_row].patients=[],scope.appointment.list[flagTheme].cals.push(data.CAL_ID),null!==data.Patient_id&&scope.appointment.list[flagTheme].doctors[doctor_row].patients.push({Patient_id:data.Patient_id,First_name:data.First_name,Sur_name:data.Sur_name,Outreferral:data.outreferral}),scope.appointment.list[flagTheme].doctors[doctor_row].PATIENTS="MESS_SYS_010",scope.appointment.list[flagTheme].doctors[doctor_row].SERVICE_ID=data.SERVICE_ID,scope.appointment.list[flagTheme].doctors[doctor_row].CAL_ID=data.CAL_ID,scope.appointment.list[flagTheme].doctors[doctor_row].SERVICE_COLOR=data.SERVICE_COLOR,scope.appointment.list[flagTheme].doctors[doctor_row].IS_REFERRAL=data.IS_REFERRAL,scope.appointment.list[flagTheme].doctors[doctor_row].IS_BOOKABLE=data.IS_BOOKABLE,scope.appointment.list[flagTheme].doctors[doctor_row].CLINICAL_DEPT_ID=data.CLINICAL_DEPT_ID,void(scope.appointment.list[flagTheme].doctors[doctor_row].patients.length>0&&(scope.appointment.list[flagTheme].doctors[doctor_row].PATIENTS="ok"))):void doctor_row++})}else{var doctors=[];_.forEach(response.doctors,function(doctor){doctors.push(doctor.DOCTOR_ID===data.DOCTOR_ID?{DOCTOR_ID:doctor.DOCTOR_ID,DOCTOR_NAME:doctor.NAME,SERVICE_ID:data.SERVICE_ID,CAL_ID:data.CAL_ID,IS_REFERRAL:data.IS_REFERRAL,IS_BOOKABLE:data.IS_BOOKABLE,SERVICE_COLOR:data.SERVICE_COLOR,PATIENTS:"MESS_SYS_010",patients:[],CLINICAL_DEPT_ID:data.CLINICAL_DEPT_ID}:{DOCTOR_ID:doctor.DOCTOR_ID,DOCTOR_NAME:doctor.NAME,PATIENTS:"###"})});var differentTimeHours=scope.differentTimeHours(data.FROM_TIME,data.TO_TIME);min_calendar>=differentTimeHours&&(min_calendar=differentTimeHours);var i=0;_.forEach(doctor_array_temp,function(doctor){doctor.DOCTOR_ID===data.DOCTOR_ID&&(doctor_array_temp[i].left=scope.differentTimeHours(data.FROM_TIME,data.TO_TIME)),i++});var cal=[];cal.push(data.CAL_ID);var object={FROM_TIME:data.FROM_TIME,TO_TIME:data.TO_TIME,cals:cal,SERVICE_ID:data.SERVICE_ID,CLINICAL_DEPT_ID:data.CLINICAL_DEPT_ID,doctors:doctors};scope.appointment.list.push(object)}}),scope.appointment.new_list=[];var i=0;if(scope.appointment.list.length>0)var begin_from_time=scope.appointment.list[0].FROM_TIME;_.forEach(scope.appointment.list,function(list){if("undefined"!=typeof scope.appointment.list[i+1])var begin_to_time=scope.appointment.list[i+1].FROM_TIME;else var begin_to_time=scope.extendMinutes(begin_from_time,45);var diff=scope.differentTimeHours(begin_from_time,begin_to_time);scope.appointment.new_list.push(scope.appointment.list[i]);var new_list_length=scope.appointment.new_list.length,j=0;_.forEach(scope.appointment.new_list[new_list_length-1].doctors,function(doctor){scope.appointment.new_list[new_list_length-1].doctors[j].border="yes",j++});for(var diff_i=15;diff-15>=diff_i;diff_i+=15){var from_time=scope.extendMinutes(scope.appointment.list[i].FROM_TIME,diff_i);begin_from_time=from_time;var temp_doctors=angular.copy(scope.appointment.list[i].doctors),doc_i=0;_.forEach(temp_doctors,function(doctor){temp_doctors[doc_i].PATIENTS="###",doc_i++}),scope.appointment.new_list.push({FROM_TIME:from_time,doctors:temp_doctors})}begin_from_time=scope.extendMinutes(begin_from_time,15),i++}),scope.appointment.list=angular.copy(scope.appointment.new_list);var i=0;_.forEach(scope.appointment.list,function(list){var j=0;_.forEach(list.doctors,function(doctor){var k=0;_.forEach(doctor_array_temp,function(temp){doctor.DOCTOR_ID===temp.DOCTOR_ID&&("###"!==doctor.PATIENTS?(doctor_array_temp[k].left_temp=doctor_array_temp[k].left-15,doctor_array_temp[k].color=scope.appointment.list[i].doctors[j].SERVICE_COLOR,0===doctor_array_temp[k].left_temp&&(scope.appointment.list[i].doctors[j].height="35px")):doctor_array_temp[k].left_temp>0&&(scope.appointment.list[i].doctors[j].SERVICE_COLOR=doctor_array_temp[k].color,doctor_array_temp[k].left_temp-=15,0===doctor_array_temp[k].left_temp&&(scope.appointment.list[i].doctors[j].height="35px"))),k++}),j++}),i++});var i=0;_.forEach(scope.appointment.list,function(list){var j=0;_.forEach(list.doctors,function(doctor){"undefined"!=typeof scope.appointment.list[i].doctors[j].patients&&scope.appointment.list[i].doctors[j].patients.length>1&&"ok"===scope.appointment.list[i].doctors[j].PATIENTS&&(scope.appointment.list[i].doctors[j].height="auto"),j++}),i++})},function(error){})},dialogWaitingListAdd=function(col){angular.element("#popupMenu").css({display:"none"});$modal.open({templateUrl:"waitingListAdd",controller:function($scope,$modalInstance,patient){$scope.success=!1,$timeout(function(){$scope.doctor_id=col.DOCTOR_ID,$scope.patient_id=patient.Patient_id},200),$scope.$watch("success",function(success){success&&$modalInstance.close("success")})},size:"lg",resolve:{col:function(){return col},patient:function(){return scope.appointment.selectedPatient}}})},dialogRightAdd=function(app,col){angular.element("#popupMenu").css({display:"none"}),dialogAdd(app,col)},dialogAdd=function(app,col){if(scope.appointment.load(),1==col.IS_BOOKABLE){var modalInstance=$modal.open({templateUrl:"appointmentAdd",controller:function($scope,$modalInstance,app,options,search){$scope.appointment={app:app,col:col},$scope.options=options,$scope.search=search,$scope.params={permission:{create:!0,edit:!1}},$scope.patient=null,$scope.$watch("patient",function(patient){null!==patient&&(-1!==patient?$modalInstance.close(patient):$modalInstance.dismiss("cancel"))})},size:"lg",resolve:{app:function(){return app},col:function(){return col},options:function(){return scope.options},search:function(){return scope.appointment.search}}});modalInstance.result.then(function(patient){if(patient){scope.appointment.load(),scope.alertCenter.load(),toastr.success("Added Successfully");var modalInstance=$modal.open({templateUrl:"notifyClaim",controller:function($scope,$modalInstance,new_patient,ClaimModel){$scope.selectClaim=function(){$modal.open({templateUrl:"claimSelect",controller:function($scope,$modalInstance,new_patient,col,toastr){var clickRow=function(row){var postData={Patient_id:new_patient.Patient_id,CAL_ID:col.CAL_ID,Claim_id:row.Claim_id};$modalInstance.close("success"),ClaimModel.addPatient(postData).then(function(response){toastr.success("You have choose claim")},function(error){})};$scope.claim={limit:10,reload:!1,Patient_id:new_patient.Patient_id,CAL_ID:col.CAL_ID,addSuccess:!1,clickRow:function(row){clickRow(row)}},$scope.$watch("claim.addSuccess",function(addSuccess){addSuccess&&$modalInstance.close("success")})},size:"lg",resolve:{new_patient:function(){return new_patient},col:function(){return col}}}).result.then(function(success){"success"===success&&$modalInstance.close("cancel")})},$scope.addClaim=function(){$modal.open({templateUrl:"claimAdd",controller:function($scope,$modalInstance,new_patient,col,toastr){$scope.claim={Patient_id:new_patient.Patient_id,CAL_ID:col.CAL_ID,success:!1},$scope.$watch("claim.success",function(success){success&&(toastr.success("You have choose claim"),$modalInstance.close("success"))})},size:"lg",resolve:{new_patient:function(){return new_patient},col:function(){return col}}}).result.then(function(success){"success"===success&&$modalInstance.close("cancel")})},$scope.cancel=function(){$modalInstance.close("cancel")}},size:"sm",backdrop:"static",keyboard:!1,resolve:{new_patient:function(){return patient}}});modalInstance.result.then(function(result){"cancel"===result&&col.IS_REFERRAL&&$modal.open({templateUrl:"notifyReferral",controller:function($scope,$modalInstance,new_patient){$scope.cancel=function(){$modalInstance.dismiss("cancel")},$scope.selectReferral=function(){$modal.open({templateUrl:"referralSelect",controller:function($scope,$modalInstance,new_patient,col,OutreferralModel){$scope.patientId=new_patient.Patient_id,$scope.reload=!1,$scope.calId=col.CAL_ID,$scope.doctorId=col.DOCTOR_ID,$scope.limit=10,$scope.addSuccess=!1,$timeout(function(){$scope.calId=col.CAL_ID},600),$scope.$watch("addSuccess",function(addSuccess){addSuccess&&$modalInstance.close("success");

}),$scope.clickRow=function(row){var postData={CAL_ID:$scope.calId,outreferral_id:row.id,patient_id:$scope.patientId,isEnable:1};OutreferralModel.select(postData).then(function(response){toastr.success("You have choose Referral"),$modalInstance.close("success")},function(error){})}},size:"lg",resolve:{new_patient:function(){return new_patient},col:function(){return col}}}).result.then(function(result){"success"===result&&($modalInstance.dismiss("cancel"),scope.alertCenter.load())})},$scope.addReferral=function(){$modal.open({templateUrl:"referralAdd",controller:function($scope,$modalInstance,new_patient,col){$scope.patientId=new_patient.Patient_id,$scope.calId=col.CAL_ID,$scope.success=!1,$timeout(function(){$scope.doctorId=col.DOCTOR_ID},600),$scope.$watch("success",function(success){success&&(toastr.success("You have choose Referral"),$modalInstance.close("success"))})},size:"lg",resolve:{new_patient:function(){return new_patient},col:function(){return col}}}).result.then(function(result){"success"===result&&($modalInstance.dismiss("cancel"),scope.alertCenter.load())})}},size:"sm",backdrop:"static",keyboard:!1,resolve:{new_patient:function(){return patient}}})})}})}else var modalInstance=$modal.open({templateUrl:"showNotificationNo",controller:function($scope,$modalInstance){$scope.cancel=function(){$modalInstance.dismiss("cancel")}}}).result.then(function(response){})},onRightClick=function($event,app,col,patient){angular.element("#popupMenu").css({display:"block",top:$event.pageY-68,left:$event.pageX-20}),scope.appointment.selectedAppointment=angular.copy(app),scope.appointment.selectedCol=angular.copy(col),scope.appointment.selectedPatient=angular.copy(patient)};scope.appointment={selectedAppointment:{},selectedCol:{},selectedPatient:{},onRightClick:function($event,app,col,patient){onRightClick($event,app,col,patient)},dialog:{rightAdd:function(app,col){dialogRightAdd(app,col)},add:function(app,col){dialogAdd(app,col)},chooseWaitingList:function(col){dialogWaitingListAdd(col)}},list:[],search:angular.copy(search),load:function(){load()}},$cookieStore.get("appointment")&&(scope.appointment.search=$cookieStore.get("appointment"),$cookieStore.remove("appointment")),scope.site={list:[],load:function(){loadSite()}},scope.doctor={headers:[]},scope.clinicalDept={list:[],load:function(){loadClinical()}};var loadAlertCenter=function(){var postData=angular.copy(scope.appointment.search);postData.datepicker=ConfigService.convertToDB(postData.datepicker),scope.alertCenter.list=[],AppointmentModel.alertCenter(postData).then(function(response){_.forEach(response.data,function(row){var flag=-1,i=0;if(_.forEach(scope.alertCenter.list,function(list){return list.Patient_id===row.Patient_id?void(flag=i):void i++}),-1!==flag){if(row.ALERT_ID){var alert_flag=!0;if(_.forEach(scope.alertCenter.list[flag].alert,function(alert){alert.id===row.ALERT_ID&&(alert_flag=!1)}),alert_flag){var object={id:row.ALERT_ID,name:row.ALERT_NAME,color:row.SERVICE_COLOR,patient_alert:row.ID,Check:row.Check,User:row.User,isUser:row.isUser,Patients_id:row.Patients_id};scope.alertCenter.list[flag].alert.push(object)}var cal_flag=!0,i=0;if(_.forEach(scope.alertCenter.list[flag].cal,function(cal){cal.CAL_ID===row.CAL_ID&&(cal_flag=!1)}),cal_flag&&(scope.alertCenter.list[flag].test=row.IS_REFERRAL,scope.alertCenter.list[flag].cal.push({IS_REFERRAL:row.IS_REFERRAL,CAL_ID:row.CAL_ID,FROM_TIME:row.FROM_TIME,TO_TIME:row.TO_TIME,OUTREFERRAL:"no",DOCTOR_ID:row.DOCTOR_ID}),row.outreferral_id)){var cal_length=scope.alertCenter.list[flag].cal.length;scope.alertCenter.list[flag].cal[cal_length-1].OUTREFERRAL="yes"}}}else{var object={Patient_id:row.Patient_id,First_name:row.First_name,Sur_name:row.Sur_name,alert:[],cal:[]};row.ALERT_ID&&object.alert.push({id:row.ALERT_ID,name:row.ALERT_NAME,color:row.SERVICE_COLOR,patient_alert:row.ID,Check:row.Check,User:row.User,isUser:row.isUser,Patients_id:row.Patients_id}),row.CAL_ID&&(object.test=row.IS_REFERRAL,object.cal.push({IS_REFERRAL:row.IS_REFERRAL,DOCTOR_ID:row.DOCTOR_ID,CAL_ID:row.CAL_ID,FROM_TIME:row.FROM_TIME,TO_TIME:row.TO_TIME,OUTREFERRAL:"no"}),row.outreferral_id&&(object.cal[0].OUTREFERRAL="yes")),scope.alertCenter.list.push(object)}})},function(error){})};scope.clickArrow=function(){scope.alertCenter.arrow=!scope.alertCenter.arrow,scope.alertCenter.arrow?(angular.element("#alert-center").css({display:"none"}),angular.element(".un_arrow").css({right:0})):(angular.element("#alert-center").css({display:"block"}),angular.element(".un_arrow").css({right:"225px"}))};var search={id:0,isCheck:0,isUser:0},onCheck=function(row){scope.alertCenter.search.id=row.patient_alert,scope.alertCenter.search.isCheck=row.Check,scope.alertCenter.search.isUser=user_id,scope.alertCenter.search.Patients_id=row.Patients_id,AppointmentModel.PostCheck(scope.alertCenter.search).then(function(response){var temp=[],temp_r=[];angular.forEach(scope.alertCenter.list,function(value,index){scope.alertCenter.list[index].Patient_id===scope.alertCenter.search.Patients_id&&temp.push(value)}),angular.forEach(temp[0].alert,function(values,indexs){temp[0].alert[indexs].patient_alert===scope.alertCenter.search.id&&temp_r.push(values)}),AppointmentModel.PostUser(user_id).then(function(resp){angular.forEach(temp_r,function(valuer,indexr){temp_r[indexr].User=resp.data[0].User}),angular.forEach(scope.alertCenter.list,function(value_y,index_y){angular.forEach(temp_r,function(value_x,index_x){scope.alertCenter.list[index_y].Patient_id===temp_r[index_x].Patients_id&&angular.forEach(scope.alertCenter.list[index_y].alert,function(value_a,index_a){})})})},function(error){})},function(error){})};scope.alertCenter={search:search,onCheck:function(row){onCheck(row)},load:function(){loadAlertCenter()},list:[],arrow:!1},scope.site.load(),scope.clinicalDept.load(),scope.appointment.load()}}}),angular.module("app.loggedIn.appointment.directives.add",[]).directive("appointmentAdd",function(ConfigService,sysServiceService,AppointmentModel,WaitingListModel,$modal,$state,toastr){return{restrict:"EA",scope:{params:"=",patient:"=",options:"=",search:"="},templateUrl:"modules/appointment/directives/templates/add.html",link:function(scope,elem,attrs){var form={PHONE:"",APP_TYPE:"",STATUS:"",AVAILABLE:null,ARR_TIME:null,ATTEND_TIME:null,bill_to:null,ACC_TYPE:null,SERVICE_ID:scope.params.col.SERVICE_ID,NOTES:""};scope.row=null,scope.wattinglist=!1;var acc_type_load=function(){ConfigService.account_type_option().then(function(response){scope.acc_type.list=response.list},function(error){})},serviceLoad=function(){sysServiceService.byClinicalDepartment(scope.params.col.CLINICAL_DEPT_ID).then(function(response){scope.service.list=response.data},function(error){})},waitingListSelect=function(){$modal.open({templateUrl:"waitingListSelect",controller:function($scope,$modalInstance){$scope.clickRow=function(row){$modalInstance.close(row)}}}).result.then(function(row){$modal.open({templateUrl:"notifyAppointment",controller:function($scope,$modalInstance){$scope.clickYes=function(){$modalInstance.close("success")},$scope.clickNo=function(){$modalInstance.dismiss("cancel")}}}).result.then(function(success){"success"===success&&(scope.wattinglist=!0,scope.row=success,scope.arr_objectNameFirst=success.First_name,scope.arr_objectNameLast=success.Sur_name)})})},patientAdd=function(){$modal.open({templateUrl:"patientAdd",controller:function($scope,$modalInstance,options,cal_id){$scope.options=options,$scope.params={permission:{create:!0,edit:!1,calendar:!0},CAL_ID:cal_id},$scope.onsuccess="",$scope.$watch("onsuccess",function(patient_id){""!==patient_id&&$modalInstance.close(patient_id)})},size:"lg",resolve:{options:function(){return scope.options},cal_id:function(){return scope.params.col.CAL_ID}}}).result.then(function(status){""!==status&&(scope.row=status,scope.arr_objectNameFirst=status.First_name,scope.arr_objectNameLast=status.Sur_name)})},patientSelect=function(){$modal.open({templateUrl:"patientList",controller:function($scope,$modalInstance){$scope.clickRow=function(row){$modalInstance.close(row)}},size:"lg"}).result.then(function(row){scope.row=row,scope.arr_objectNameFirst=row.First_name,scope.arr_objectNameLast=row.Sur_name})};scope.Ok=function(){var postData=ConfigService.convertToDB(scope.search.datepicker).toString();AppointmentModel.ApptG(postData).then(function(response){if(scope.row){var postData={form:{},Patient_id:null};postData.form=angular.copy(scope.appointment.form),postData.form.ARR_TIME=ConfigService.convertToDB(postData.ARR_TIME),postData.form.ATTEND_TIME=ConfigService.convertToDB(postData.ATTEND_TIME),postData.form.CAL_ID=scope.params.col.CAL_ID,postData.Patient_id=scope.row.Patient_id,AppointmentModel.add(postData).then(function(response){scope.patient=scope.row},function(error){}),1==scope.wattinglist&&WaitingListModel.remove({id:scope.row.id}).then(function(response){},function(error){})}},function(error){})},scope.cancel=function(){scope.patient=-1},scope.acc_type={load:function(){acc_type_load()},list:[]},scope.service={load:function(){serviceLoad()},list:[]},scope.acc_type.load(),scope.service.load(),scope.appointment={form:form},scope.app_patient={dialog:{add:function(){patientAdd()},select:function(){patientSelect()},waitingListSelect:function(){waitingListSelect()}}}}}});