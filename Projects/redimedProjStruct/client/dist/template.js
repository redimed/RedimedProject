angular.module("app.loggedIn.template",["app.loggedIn.template.include"]).config(function($stateProvider){$stateProvider.state("loggedIn.template",{url:"/template",templateUrl:"modules/template/views/list.html",controller:"TemplateListController"}).state("loggedIn.template_add",{url:"/template/add",templateUrl:"modules/template/views/add.html",controller:"TemplateAddController"}).state("loggedIn.template_write",{url:"/template/write/:id",templateUrl:"modules/template/views/write.html",controller:"TemplateWriteController"}).state("loggedIn.template_edit",{url:"/template/edit/:id",templateUrl:"modules/template/views/edit.html",controller:"TemplateEditController"}).state("loggedIn.patient.template",{url:"/template",views:{"main-content":{templateUrl:"modules/template/views/patient_list.html",controller:"TemplatePatientListController"}}}).state("loggedIn.patient.template_add",{url:"/template/add",views:{"main-content":{templateUrl:"modules/template/views/patient_add.html",controller:"TemplatePatientAddController"}}})}),angular.module("app.loggedIn.template.include",["app.loggedIn.template.controllers.list","app.loggedIn.template.controllers.patient_list","app.loggedIn.template.controllers.patient_add","app.loggedIn.template.controllers.add","app.loggedIn.template.controllers.edit","app.loggedIn.template.controllers.write","app.loggedIn.template.model","app.loggedIn.template.directives.list","app.loggedIn.template.directives.patient_list","app.loggedIn.template.directives.patient_write","app.loggedIn.template.directives.patient_add","app.loggedIn.template.directives.patient_edit","app.loggedIn.template.directives.add","app.loggedIn.template.directives.edit","app.loggedIn.template.directives.write"]),angular.module("app.loggedIn.template.model",[]).factory("TemplateModel",function(Restangular,$http){var instanceService={},appApi=Restangular.all("api/meditek/v1/template");return instanceService.add=function(data){var detailApi=appApi.all("add");return detailApi.post({data:data})},instanceService.update=function(data){var detailApi=appApi.all("update");return detailApi.post({data:data})},instanceService.list=function(data){var detailApi=appApi.all("list");return detailApi.post({data:data})},instanceService.one=function(data){var detailApi=appApi.all("one");return detailApi.post({data:data})},instanceService["delete"]=function(data){var detailApi=appApi.all("delete");return detailApi.post({data:data})},instanceService.write=function(data){var detailApi=appApi.all("write");return detailApi.post({data:data})},instanceService.download=function(data){return"http://testapp.redimed.com.au:3003/RedimedJavaREST/api/document/template/"+data.id},instanceService}),angular.module("app.loggedIn.template.controllers.list",[]).controller("TemplateListController",function($scope,$modal,toastr){}),angular.module("app.loggedIn.template.directives.list",[]).directive("templateList",function($modal,$http,$state,$cookieStore,TemplateModel,toastr,PatientService){return{restrict:"EA",scope:{limit:"=",reload:"="},templateUrl:"modules/template/directives/templates/list.html",link:function(scope,elem,attrs){scope.removeList=function(list){var modalInstance=$modal.open({templateUrl:"removeTemplate",controller:function($scope,$modalInstance){$scope.clickNo=function(){$modalInstance.dismiss("cancel")},$scope.clickYes=function(){$modalInstance.close("success")}}});modalInstance.result.then(function(response){response&&TemplateModel["delete"]({id:list.id}).then(function(){load()})})},scope.goToAdd=function(){$state.go("loggedIn.template_add")},scope.goToWrite=function(list){$state.go("loggedIn.template_write",{id:list.id})},scope.goToEdit=function(list){$state.go("loggedIn.template_edit",{id:list.id})};var load=function(){TemplateModel.list({}).then(function(response){scope.template.list=response.data},function(error){})};scope.template={list:[]},load()}}}),angular.module("app.loggedIn.template.controllers.patient_list",[]).controller("TemplatePatientListController",function($scope,$modal,toastr){}),angular.module("app.loggedIn.template.directives.patient_list",[]).directive("templatePatientList",function($modal,$modal,$state,$cookieStore,TemplateModel,toastr,PatientService){return{restrict:"EA",scope:{patientId:"=",calId:"=",success:"="},templateUrl:"modules/template/directives/templates/patient_list.html",link:function(scope,elem,attrs){scope.goToWrite=function(list){var modalInstance=$modal.open({templateUrl:"writeTemplateDialog",size:"lg",controller:function($scope,$modalInstance,patientId,calId){$scope.patient_id=patientId,$scope.cal_id=calId,$scope.success=null,$scope.template_id=list.id,$scope.$watch("success",function(success){success&&$modalInstance.close(success)})},resolve:{patientId:function(){return scope.patientId},calId:function(){return scope.calId}}});modalInstance.result.then(function(result){console.log(result),scope.success=result})},scope.goToEdit=function(list){var modalInstance=$modal.open({templateUrl:"editTemplateDialog",size:"lg",controller:function($scope,$modalInstance,patientId,calId){$scope.patient_id=patientId,$scope.cal_id=calId,$scope.success=!1,$scope.template_id=list.id,$scope.$watch("success",function(success){success&&$modalInstance.close("success")})},resolve:{patientId:function(){return scope.patientId},calId:function(){return scope.calId}}});modalInstance.result.then(function(result){"success"===result&&load()})},scope.goToAdd=function(){var modalInstance=$modal.open({templateUrl:"addTemplateDialog",size:"lg",controller:function($scope,$modalInstance,patientId,calId){$scope.patient_id=patientId,$scope.cal_id=calId,$scope.success=!1,$scope.$watch("success",function(success){success&&$modalInstance.close("success")})},resolve:{patientId:function(){return scope.patientId},calId:function(){return scope.calId}}});modalInstance.result.then(function(result){"success"===result&&load()})},scope.removeList=function(list){var modalInstance=$modal.open({templateUrl:"removeTemplate",controller:function($scope,$modalInstance){$scope.clickNo=function(){$modalInstance.dismiss("cancel")},$scope.clickYes=function(){$modalInstance.close("success")}}});modalInstance.result.then(function(response){response&&TemplateModel["delete"]({id:list.id}).then(function(){load()})})};var load=function(){TemplateModel.list({}).then(function(response){scope.template.list=response.data},function(error){})};scope.template={list:[]},load()}}}),angular.module("app.loggedIn.template.controllers.patient_add",[]).controller("TemplatePatientAddController",function($scope,$modal,toastr){}),angular.module("app.loggedIn.template.directives.patient_add",[]).directive("templatePatientAdd",function($modal,$cookieStore,$state,TemplateModel,toastr,PatientService){return{restrict:"EA",scope:{patientId:"=",calId:"=",success:"="},templateUrl:"modules/template/directives/templates/patient_add.html",link:function(scope,elem,attrs){var user_id=$cookieStore.get("userInfo").id,patientLoad=function(patient_id){PatientService.get(patient_id).then(function(response){scope.patient.one=response.data},function(error){})};scope.patient={one:null,load:function(patient_id){patientLoad(patient_id)}},scope.$watch("patientId",function(patientId){"undefined"!=typeof patientId&&scope.patient.load(patientId)});var element=$("#editor");element.wysiwyg({toolbar:"top",buttons:{bold:{title:"Bold (Ctrl+B)",image:"",hotkey:"b"},italic:{title:"Italic (Ctrl+I)",image:"",hotkey:"i"},underline:{title:"Underline (Ctrl+U)",image:"",hotkey:"u"},insertimage:{title:"Insert image",image:"",showselection:!0},fontname:{title:"Font",image:"",popup:function($popup,$button){var list_fontnames={"Arial, Helvetica":"Arial,Helvetica",Verdana:"Verdana,Geneva",Georgia:"Georgia","Courier New":"Courier New,Courier","Times New Roman":"Times New Roman,Times"},$list=$("<div/>").addClass("wysiwyg-plugin-list").attr("unselectable","on");$.each(list_fontnames,function(name,font){var $link=$("<a/>").attr("href","#").css("font-family",font).html(name).click(function(event){return $(element).wysiwyg("shell").fontName(font).closePopup(),event.stopPropagation(),event.preventDefault(),!1});$list.append($link)}),$popup.append($list)},showselection:!1},strikethrough:{title:"Strikethrough (Ctrl+S)",image:"",hotkey:"s"},forecolor:{title:"Text color",image:""},highlight:{title:"Background color",image:""},alignleft:{title:"Left",image:"",showselection:!1},aligncenter:{title:"Center",image:"",showselection:!1},alignright:{title:"Right",image:"",showselection:!1},alignjustify:{title:"Justify",image:"",showselection:!1},subscript:{title:"Subscript",image:"",showselection:!0},superscript:{title:"Superscript",image:"",showselection:!0},indent:{title:"Indent",image:"",showselection:!1},outdent:{title:"Outdent",image:"",showselection:!1},orderedList:{title:"Ordered list",image:"",showselection:!1},unorderedList:{title:"Unordered list",image:"",showselection:!1},removeformat:{title:"Remove format",image:""}},selectImage:"Click or drop image",placeholderUrl:"http://sasa",maxImageSize:[600,200],forceImageUpload:!1,submit:{title:"Submit",image:""},onAutocomplete:function(tyed,key,character,shiftKey,altKey,ctrlKey,metaKey){if(0==tyed.indexOf("<")){var fields={First_name:"First_name",Sur_name:"Sur_name",Middle_name:"Middle_name",Address1:"Address1",Surburb:"Surburb",Post_code:"Post_code",Home_phone:"Home_phone",Work_phone:"Work_phone",Mobile:"Mobile",Phone_ext:"Phone_ext",Medicare_no:"Medicare_no",Ref:"Ref",Exp_medicare:"Exp_medicare"},field_r=[];for(var key in fields)field_r.push(key);var $list=$("<div/>").addClass("wysiwyg-plugin-list").attr("unselectable","on");if($.each(fields,function(index,field){var $link=$("<a/>").attr("href","javascript:void(0)").text(field).click(function(event){var html="."+field,editor=$(element).wysiwyg("shell");return editor.expandSelection(tyed.length,0).insertHTML(html),editor.closePopup().getElement().focus(),event.stopPropagation(),event.preventDefault(),!1});$list.append($link)}),$list.children().length){if(13==key)return $list.children(":first").click(),!1;if(character||8==key)return $list}}}}),scope.form={name:null},scope.save=function(){var html=element.wysiwyg("shell").getHTML(),postData={name:scope.form.name,content:html,user_id:user_id};TemplateModel.add(postData).then(function(response){scope.success=!0},function(error){})}}}}),angular.module("app.loggedIn.template.directives.patient_write",[]).directive("templatePatientWrite",function($modal,$window,$cookieStore,$state,$stateParams,$timeout,TemplateModel,toastr,PatientService){return{restrict:"EA",scope:{id:"=",patientId:"=",calId:"=",success:"="},templateUrl:"modules/template/directives/templates/patient_write.html",link:function(scope,elem,attrs){scope.exportPDF=function(){var content=$("#writeTemplate").html();content=content.replace(/&nbsp;&nbsp;/g,"</input>"),content=content.replace(/test/g,"</img>"),content=content.replace(/<br>/g,"<br/>"),console.log("%%%%%%%%%%%%%%%%%%%%%%: ",content),TemplateModel.write({name:scope.template.one.name,content:content}).then(function(response){$window.open(TemplateModel.download({id:response.data.id}))},function(error){})};var patientLoad=function(patient_id){PatientService.getP(patient_id).then(function(response){scope.patient.one=response.data,loadTemplate(scope.id)},function(error){})};scope.patient={one:null,load:function(patient_id){patientLoad(patient_id)}},scope.$watch("patientId",function(patientId){"undefined"!=typeof patientId&&scope.patient.load(patientId)});var loadTemplate=function(id){TemplateModel.one({id:id}).then(function(response){scope.template.one=response.data[0];for(var content=scope.template.one.content,new_content="";-1!==content.indexOf("{#input");){var index_first=content.indexOf("{#input"),index_last=content.indexOf("#}"),string_change=content.substring(index_first+2,index_last),split_string_change=string_change.split("."),new_string_change="";if(1===split_string_change.length)new_string_change='<input class="custom-input-template" value="" placeholder="Please fill in">&nbsp;&nbsp;';else for(var field=split_string_change[1],i=0;i<scope.patient.one.length;i++)for(var key in scope.patient.one[i])if(key===field){new_string_change=scope.patient.one[i][key];break}new_content+=content.substring(0,index_last+2),new_content=new_content.replace("{#"+string_change+"#}",new_string_change),content=content.substring(index_last+2,content.length)}new_content+=content,$("#writeTemplate").html(new_content),$(".custom-input-template").on("input",function(e){$(this).attr("size",e.target.value.length),$(this).attr("value",e.target.value)})})};scope.template={one:null},scope.patient.load()}}}),angular.module("app.loggedIn.template.directives.patient_edit",[]).directive("templatePatientEdit",function($modal,$cookieStore,$state,$stateParams,TemplateModel,toastr,PatientService){return{restrict:"EA",scope:{id:"=",patientId:"=",calId:"=",success:"="},templateUrl:"modules/template/directives/templates/patient_edit.html",link:function(scope,elem,attrs){var patientLoad=($cookieStore.get("userInfo").id,function(patient_id){PatientService.get(patient_id).then(function(response){scope.patient.one=response.data},function(error){})});scope.patient={one:null,load:function(patient_id){patientLoad(patient_id)}},scope.$watch("patientId",function(patientId){"undefined"!=typeof patientId&&scope.patient.load(patientId)});var element=$("#editor");element.wysiwyg({toolbar:"top",forceImageUpload:!0,onImageUpload:function(insert_image){console.log("###############: ",insert_image)},buttons:{bold:{title:"Bold (Ctrl+B)",image:"",hotkey:"b"},italic:{title:"Italic (Ctrl+I)",image:"",hotkey:"i"},underline:{title:"Underline (Ctrl+U)",image:"",hotkey:"u"},insertimage:{title:"Insert image",image:"",showselection:!0},fontname:{title:"Font",image:"",popup:function($popup,$button){var list_fontnames={"Arial, Helvetica":"Arial,Helvetica",Verdana:"Verdana,Geneva",Georgia:"Georgia","Courier New":"Courier New,Courier","Times New Roman":"Times New Roman,Times"},$list=$("<div/>").addClass("wysiwyg-plugin-list").attr("unselectable","on");$.each(list_fontnames,function(name,font){var $link=$("<a/>").attr("href","#").css("font-family",font).html(name).click(function(event){return $(element).wysiwyg("shell").fontName(font).closePopup(),event.stopPropagation(),event.preventDefault(),!1});$list.append($link)}),$popup.append($list)},showselection:!1},strikethrough:{title:"Strikethrough (Ctrl+S)",image:"",hotkey:"s"},forecolor:{title:"Text color",image:""},highlight:{title:"Background color",image:""},alignleft:{title:"Left",image:"",showselection:!1},aligncenter:{title:"Center",image:"",showselection:!1},alignright:{title:"Right",image:"",showselection:!1},alignjustify:{title:"Justify",image:"",showselection:!1},subscript:{title:"Subscript",image:"",showselection:!0},superscript:{title:"Superscript",image:"",showselection:!0},indent:{title:"Indent",image:"",showselection:!1},outdent:{title:"Outdent",image:"",showselection:!1},orderedList:{title:"Ordered list",image:"",showselection:!1},unorderedList:{title:"Unordered list",image:"",showselection:!1},removeformat:{title:"Remove format",image:""}},selectImage:"Click or drop image",placeholderUrl:"http://sasa",maxImageSize:[600,200],forceImageUpload:!1,submit:{title:"Submit",image:""},onAutocomplete:function(tyed,key,character,shiftKey,altKey,ctrlKey,metaKey){if(0==tyed.indexOf("<")){var fields={First_name:"First_name",Sur_name:"Sur_name",Middle_name:"Middle_name",Address1:"Address1",Surburb:"Surburb",Post_code:"Post_code",Home_phone:"Home_phone",Work_phone:"Work_phone",Mobile:"Mobile",Phone_ext:"Phone_ext",Medicare_no:"Medicare_no",Ref:"Ref",Exp_medicare:"Exp_medicare"},field_r=[];for(var key in fields)field_r.push(key);var $list=$("<div/>").addClass("wysiwyg-plugin-list").attr("unselectable","on");if($.each(fields,function(index,field){var $link=$("<a/>").attr("href","javascript:void(0)").text(field).click(function(event){var html="."+field,editor=$(element).wysiwyg("shell");return editor.expandSelection(tyed.length,0).insertHTML(html),editor.closePopup().getElement().focus(),event.stopPropagation(),event.preventDefault(),!1});$list.append($link)}),$list.children().length){if(13==key)return $list.children(":first").click(),!1;if(character||8==key)return $list}}}}),scope.form={name:null},scope.save=function(){var html=element.wysiwyg("shell").getHTML(),postData={name:scope.form.name,content:html,id:scope.id};TemplateModel.update(postData).then(function(response){scope.success=!0},function(error){})};var loadTemplate=function(){TemplateModel.one({id:scope.id}).then(function(response){scope.form=response.data[0],element.wysiwyg("shell").setHTML(scope.form.content)})};scope.$watch("id",function(id){"undefined"!=typeof id&&loadTemplate()})}}}),angular.module("app.loggedIn.template.controllers.add",[]).controller("TemplateAddController",function($scope,$modal,toastr){}),angular.module("app.loggedIn.template.directives.add",[]).directive("templateAdd",function($modal,$cookieStore,$state,TemplateModel,toastr){return{restrict:"EA",scope:{},templateUrl:"modules/template/directives/templates/add.html",link:function(scope,elem,attrs){var user_id=$cookieStore.get("userInfo").id,quill=new Quill("#editor",{modules:{authorship:{authorId:"advanced",enabled:!0},"link-tooltip":!0,"image-tooltip":!0,"multi-cursor":!0},theme:"snow"});quill.addModule("toolbar",{container:"#toolbar"}),scope.form={name:null},scope.save=function(){var html=quill.getHTML(),postData={name:scope.form.name,content:html,user_id:user_id};TemplateModel.add(postData).then(function(response){$state.go("loggedIn.template")},function(error){})}}}}),angular.module("app.loggedIn.template.controllers.write",[]).controller("TemplateWriteController",function($scope,$modal,toastr){}),angular.module("app.loggedIn.template.directives.write",[]).directive("templateWrite",function($modal,$cookieStore,$state,$stateParams,$timeout,TemplateModel,toastr,PatientService){return{restrict:"EA",scope:{},templateUrl:"modules/template/directives/templates/write.html",link:function(scope,elem,attrs){scope.savePDF=function(){var doc=new jsPDF;doc.fromHTML($("#writeTemplate").get(0),15,15,{width:170}),doc.save("test.pdf")};var patientLoad=function(patient_id){PatientService.getP(patient_id).then(function(response){scope.patient.one=response.data,loadTemplate(),console.log("**************** ",scope.patient.one)},function(error){})};if(scope.patient={one:null,load:function(patient_id){patientLoad(patient_id)}},$cookieStore.get("template_patient_id")){var patient_id=$cookieStore.get("template_patient_id");scope.patient.load(patient_id)}var loadTemplate=function(){console.log("%%%%%%%%%%%%%%%%% ",scope.patient.one),TemplateModel.one({id:$stateParams.id}).then(function(response){scope.template.one=response.data[0];for(var content=scope.template.one.content,new_content="";-1!==content.indexOf("{#input");){var index_first=content.indexOf("{#input"),index_last=content.indexOf("#}"),string_change=content.substring(index_first+2,index_last),split_string_change=string_change.split("."),new_string_change="";if(1===split_string_change.length)new_string_change='<input class="custom-input-template" placeholder="Please fill in"/>';else{var field=split_string_change[1];for(var key in scope.patient.one)if(key===field){new_string_change=scope.patient.one[key];break}}new_content+=content.substring(0,index_last+2),new_content=new_content.replace("{#"+string_change+"#}",new_string_change),content=content.substring(index_last+2,content.length)}$("#writeTemplate").html(new_content),$(".custom-input-template").on("input",function(e){$(this).attr("size",e.target.value.length)})})};scope.template={one:null},scope.patient.load()}}}),angular.module("app.loggedIn.template.controllers.edit",[]).controller("TemplateEditController",function($scope,$modal,toastr){}),angular.module("app.loggedIn.template.directives.edit",[]).directive("templateEdit",function($modal,$cookieStore,$state,$stateParams,TemplateModel,toastr,PatientService){return{restrict:"EA",scope:{},templateUrl:"modules/template/directives/templates/edit.html",link:function(scope,elem,attrs){var quill=($cookieStore.get("userInfo").id,new Quill("#editor",{modules:{"link-tooltip":!0,"image-tooltip":!0,"multi-cursor":!0},theme:"snow"}));quill.addModule("toolbar",{container:"#toolbar"}),scope.form={name:null},scope.save=function(){var html=quill.getHTML(),postData={name:scope.form.name,content:html,id:$stateParams.id};TemplateModel.update(postData).then(function(response){$state.go("loggedIn.template")},function(error){})};var loadTemplate=function(){TemplateModel.one({id:$stateParams.id}).then(function(response){scope.form=response.data[0],quill.setHTML(scope.form.content)})};loadTemplate()}}});