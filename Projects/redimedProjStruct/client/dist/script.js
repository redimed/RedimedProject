angular.module("app.loggedIn.script.include",["app.loggedIn.script.list.controller","app.loggedIn.script.model","app.loggedIn.script.add.controller","app.loggedIn.script.edit.controller","app.loggedIn.script.directive.list","app.loggedIn.script.directive.add","app.loggedIn.script.directive.edit"]),angular.module("app.loggedIn.script",["app.loggedIn.script.include"]).config(function($stateProvider){$stateProvider.state("loggedIn.patient.script",{url:"/script",views:{"main-content":{templateUrl:"modules/script/views/list.html",controller:"ScriptListController"}}}).state("loggedIn.patient.script.add",{url:"/add",views:{"@loggedIn":{templateUrl:"modules/script/views/add.html",controller:"ScriptAddController"}}}).state("loggedIn.patient.script.edit",{url:"/edit/:scriptId",views:{"@loggedIn":{templateUrl:"modules/script/views/edit.html",controller:"ScriptEditController"}}})}),angular.module("app.loggedIn.script.list.controller",[]).controller("ScriptListController",function($scope,$state){}),angular.module("app.loggedIn.script.add.controller",[]).controller("ScriptAddController",function($scope,$state,$modalInstance,medicare){$scope.scriptadd={success:!1,medicare:medicare},console.log("_________",medicare),$scope.$watch("scriptadd.success",function(success){success&&$modalInstance.close($scope.scriptadd)})}),angular.module("app.loggedIn.script.edit.controller",[]).controller("ScriptEditController",function($scope,$state,$modalInstance,ID,medicare){$scope.scriptedit={success:!1,ID:ID,medicare:medicare},$scope.$watch("scriptedit.success",function(success){success&&$modalInstance.close($scope.scriptedit)})}),angular.module("app.loggedIn.script.model",[]).factory("ScriptModel",function(Restangular){var mainModel={},mainApi=Restangular.all("api/meditek/v1/script/");return mainModel.list=function(data){var instanceApi=mainApi.all("list");return instanceApi.post({data:data})},mainModel.add=function(data){var instanceApi=mainApi.all("add");return instanceApi.post({data:data})},mainModel.edit=function(data){var instanceApi=mainApi.all("edit");return instanceApi.post({data:data})},mainModel.remove=function(data){var instanceApi=mainApi.all("remove");return instanceApi.post({data:data})},mainModel.byid=function(data){var instanceApi=mainApi.all("byid");return instanceApi.post({data:data})},mainModel.postDisable=function(data){var instanceApi=mainApi.all("disable");return instanceApi.post({data:data})},mainModel.postSing=function(data){var instanceApi=mainApi.all("signature");return instanceApi.post({data:data})},mainModel.postScriptHead=function(data){var instanceApi=mainApi.all("addScriptHead");return instanceApi.post({data:data})},mainModel.listpostHead=function(data,datar){var instanceApi=mainApi.all("listscriptHead");return instanceApi.post({data:data,datar:datar})},mainModel.editHead=function(data,datar){var instanceApi=mainApi.all("editcriptHead");return instanceApi.post({data:data,datar:datar})},mainModel}),angular.module("app.loggedIn.script.directive.list",[]).directive("scriptList",function(ScriptModel,PatientService,$modal,$filter,$stateParams,$state,toastr){return{restrict:"EA",templateUrl:"modules/script/directives/templates/list.html",scope:{options:"=",limit:"@",medicare:"="},link:function(scope,ele,attrs){var search={page:1,limit:20,offset:0,max_size:5,scriptNum:"",medication_name:"",isEnable:"",Patient_id:$stateParams.patient_id,CAL_ID:$stateParams.cal_id,Creation_date:"desc"},load=function(){console.log("fdsfds: ",scope.medicare),ScriptModel.list(search).then(function(response){scope.script.list=response.data,scope.script.count=response.count},function(error){})},onSearch=function(option){switch(option.field){case"scriptNum":scope.script.search.scriptNum=option.value;break;case"medication_name":scope.script.search.medication_name=option.value}scope.script.load()},remove=function(id){var modalInstance=$modal.open({templateUrl:"notifyToRemove",controller:function($scope,id,$modalInstance){$scope.ok=function(){$modalInstance.close(id)},$scope.cancel=function(){$modalInstance.dismiss("cancel")}},size:"sm",resolve:{id:function(){return id}}});modalInstance.result.then(function(id){id&&ScriptModel.remove(id).then(function(deleted){toastr.success("Deleted Successfully"),scope.script.load()},function(error){})})};scope.Scripts=function(type,index){if("new"==type){$modal.open({templateUrl:"notifyToAdd",controller:"ScriptAddController",size:"lg",resolve:{medicare:function(){return scope.medicare}}}).result.then(function(response){scope.script.load()})}if("edit"==type){$modal.open({templateUrl:"notifyToEdit",controller:"ScriptEditController",size:"lg",resolve:{ID:function(){return index},medicare:function(){return scope.medicare}}}).result.then(function(response){response&&scope.script.load()})}};var disable=function(row){ScriptModel.postDisable(row).then(function(response){scope.script.load()},function(error){})};scope.setPage=function(page){scope.script.search.offset=(page-1)*scope.script.search.limit,scope.script.load()},scope.script={search:search,dialog:{remove:function(id){remove(id)}},loading:!1,list:[],count:0,error:"",disable:function(row){disable(row)},load:function(){load()},onSearch:function(option){onSearch(option)}},scope.script.load()}}}),angular.module("app.loggedIn.script.directive.add",[]).directive("scriptAdd",function(ScriptModel,PatientService,OutreferralModel,AppointmentModel,ConfigService,toastr,$cookieStore,$filter,$state,$stateParams,$modal){return{restrict:"EA",templateUrl:"modules/script/directives/templates/add.html",scope:{options:"=",success:"=",medicare:"="},link:function(scope,ele,attrs){var user_id=$cookieStore.get("userInfo").id,save=function(){ConfigService.beforeSave(scope.script.errors),scope.script.errors=[];var postData=angular.copy(scope.script.form),postDatar=[];angular.forEach(scope.script_s,function(value_script,index_script){"1"===scope.script_s[index_script].Checked&&postDatar.push(value_script)}),postData.Patient_id=$stateParams.patient_id,postData.CAL_ID=$stateParams.cal_id,postData.Creation_date=moment().format("YYYY-MM-DD"),postData.Last_update_date=moment().format("YYYY-MM-DD"),postData.Created_by=postData.Last_updated_by=user_id,postData.doctordate=ConfigService.convertToDB(postData.doctordate.toString()),postData.patientDate=ConfigService.convertToDB(postData.patientDate.toString()),ScriptModel.add(postData).then(function(response){toastr.success("Added Successfully"),scope.success=!0,angular.forEach(postDatar,function(value_post,index_post){postDatar[index_post].start_date=ConfigService.convertToDB(postDatar[index_post].start_date.toString()),postDatar[index_post].end_date=ConfigService.convertToDB(postDatar[index_post].end_date.toString()),postDatar[index_post].ID_SCRIPT=response.data,postDatar[index_post].CAL_ID=$stateParams.cal_id}),ScriptModel.postScriptHead(postDatar).then(function(responser){},function(error){})},function(error){scope.script.errors=angular.copy(error.data.errors),ConfigService.beforeError(scope.script.errors)})},patientLoad=function(){PatientService.get($stateParams.patient_id).then(function(response){scope.patient.item=response.data},function(error){})};scope.patient={item:{},load:function(){patientLoad()}};var scriptLoad=function(){scope.script_s=angular.copy(scope.medicare),angular.forEach(scope.script_s,function(value_script,index_script){scope.script_s[index_script].Checked=null,scope.script_s[index_script].Created_by=user_id,scope.script_s[index_script].Creation_date=moment().format("YYYY-MM-DD"),scope.script_s[index_script].Last_updated_by=user_id,scope.script_s[index_script].Last_update_date=moment().format("YYYY-MM-DD")}),ScriptModel.postSing(user_id).then(function(response){console.log("+++++++++++++++++: ",response.data),scope.script.form.doctorSign=response.data.Signature,scope.script.form.patientDate=moment().format("DD/MM/YYYY"),scope.script.form.doctordate=moment().format("DD/MM/YYYY")},function(error){})},getUsername=function(){OutreferralModel.DotorFromUserId(user_id).then(function(response){scope.script.form.prescriber=response.data[0].NAME},function(error){})};scope.script={getUsername:function(){getUsername()},add:function(params){save(params)},load:function(){scriptLoad()},errors:[],form:{prescriber:"",scriptNum:0,isRefNo:0,EntitlementNo:"",isSafety:0,isConcessional:0,isPBS:0,isRPBS:0,isBrand:0,MedicareNo:0,doctorSign:"",doctordate:"",patientSign:"",patientDate:"",agentAddress:""}},scope.script.load(),scope.patient.load(),scope.script.getUsername()}}}),angular.module("app.loggedIn.script.directive.edit",[]).directive("scriptEdit",function(ScriptModel,PatientService,ConfigService,$cookieStore,$filter,$state,$stateParams,toastr){return{restrict:"EA",templateUrl:"modules/script/directives/templates/edit.html",scope:{options:"=",success:"=",id:"=",medicare:"="},link:function(scope,ele,attr){var user_id=$cookieStore.get("userInfo").id;patientLoad=function(){PatientService.get($stateParams.patient_id).then(function(response){scope.patient.item=response.data},function(error){})},scope.patient={item:{},load:function(){patientLoad()}};var load=function(){scope.script_s=angular.copy(scope.medicare),angular.forEach(scope.script_s,function(value_script,index_script){scope.script_s[index_script].Checked=null,scope.script_s[index_script].Created_by=user_id,scope.script_s[index_script].Creation_date=moment().format("YYYY-MM-DD"),scope.script_s[index_script].Last_updated_by=user_id,scope.script_s[index_script].Last_update_date=moment().format("YYYY-MM-DD")}),ScriptModel.listpostHead(scope.id,$stateParams.cal_id).then(function(responser){scope.list=angular.copy(responser.data),angular.forEach(scope.list,function(value_script,index_script){scope.list[index_script].start_date=ConfigService.convertToDate_F(scope.list[index_script].start_date),scope.list[index_script].end_date=ConfigService.convertToDate_F(scope.list[index_script].end_date)}),angular.forEach(scope.script_s,function(value_script,index_script){var flag=!0;angular.forEach(scope.list,function(value_s,index_s){return scope.script_s[index_script].medication_name==scope.list[index_s].medication_name?void(flag=!1):void 0}),flag&&scope.script.s_array.push(value_script)})},function(error){}),scope.$watch("id",function(success){scope.id=success}),ScriptModel.byid(scope.id).then(function(response){scope.script.form=angular.copy(response.data),scope.script.form.doctordate=ConfigService.convertToDate_F(scope.script.form.doctordate),scope.script.form.patientDate=ConfigService.convertToDate_F(scope.script.form.patientDate)},function(error){})},save=function(){ConfigService.beforeSave(scope.script.errors),scope.script.errors=[];var postData=angular.copy(scope.script.form);postData.Patient_id=$stateParams.patient_id,postData.CAL_ID=$stateParams.cal_id,postData.Last_updated_by=user_id,postData.ID=scope.id,postData.Creation_date=moment().format("YYYY-MM-DD"),postData.Last_update_date=moment().format("YYYY-MM-DD"),postData.doctordate=ConfigService.convertToDB(postData.doctordate),postData.patientDate=ConfigService.convertToDB(postData.patientDate);var postDatar=[];angular.forEach(scope.script.s_array,function(values,indexs){"1"===scope.script.s_array[indexs].Checked&&postDatar.push(values)});var postDatary=[];angular.forEach(scope.list,function(valuesy,indexsy){"0"===scope.list[indexsy].Checked&&postDatary.push(valuesy)}),console.log("^^::::::::::::: ",postDatary),ScriptModel.edit(postData).then(function(response){toastr.success("Edited Successfully"),scope.success=!0,angular.forEach(postDatar,function(value_p,index_p){postDatar[index_p].start_date=ConfigService.convertToDB(postDatar[index_p].start_date),postDatar[index_p].end_date=ConfigService.convertToDB(postDatar[index_p].end_date),postDatar[index_p].ID_SCRIPT=scope.id,postDatar[index_p].CAL_ID=$stateParams.cal_id}),ScriptModel.editHead(postDatar,postDatary).then(function(response){},function(error){})},function(error){scope.script.errors=angular.copy(error.data.errors),ConfigService.beforeError(scope.script.errors)})};scope.script={s_array:[],save:function(id){save()},errors:[],load:function(){load()},form:{ID:"",Patient_id:"",CAL_ID:"",prescriber:"",scriptNum:0,isRefNo:0,EntitlementNo:"",isSafety:0,isConcessional:0,isPBS:0,isRPBS:0,isBrand:0,pharmacist:"",doctorSign:"",doctordate:"",patientSign:"",patientDate:"",agentAddress:""}},scope.patient.load(),scope.script.load()}}});