angular.module("app.loggedIn.script.include",["app.loggedIn.script.list.controller","app.loggedIn.script.model","app.loggedIn.script.add.controller","app.loggedIn.script.edit.controller","app.loggedIn.script.directive.list","app.loggedIn.script.directive.add","app.loggedIn.script.directive.edit"]),angular.module("app.loggedIn.script",["app.loggedIn.script.include"]).config(function($stateProvider){$stateProvider.state("loggedIn.patient.script",{url:"/script",views:{"main-content":{templateUrl:"modules/script/views/list.html",controller:"ScriptListController"}}}).state("loggedIn.patient.script.add",{url:"/add",views:{"@loggedIn":{templateUrl:"modules/script/views/add.html",controller:"ScriptAddController"}}}).state("loggedIn.patient.script.edit",{url:"/edit/:scriptId",views:{"@loggedIn":{templateUrl:"modules/script/views/edit.html",controller:"ScriptEditController"}}})}),angular.module("app.loggedIn.script.list.controller",[]).controller("ScriptListController",function($scope,$state){}),angular.module("app.loggedIn.script.add.controller",[]).controller("ScriptAddController",function($scope,$state,$modalInstance,medicare){$scope.scriptadd={success:!1,medicare:medicare},console.log("_________",medicare),$scope.$watch("scriptadd.success",function(success){success&&$modalInstance.close($scope.scriptadd)})}),angular.module("app.loggedIn.script.edit.controller",[]).controller("ScriptEditController",function($scope,$state,$modalInstance,ID,medicare){$scope.scriptedit={success:!1,ID:ID,medicare:medicare},$scope.$watch("scriptedit.success",function(success){success&&$modalInstance.close($scope.scriptedit)})}),angular.module("app.loggedIn.script.model",[]).factory("ScriptModel",function(Restangular){var mainModel={},mainApi=Restangular.all("api/meditek/v1/script/");return mainModel.list=function(data){var instanceApi=mainApi.all("list");return instanceApi.post({data:data})},mainModel.add=function(data){var instanceApi=mainApi.all("add");return instanceApi.post({data:data})},mainModel.edit=function(data){var instanceApi=mainApi.all("edit");return instanceApi.post({data:data})},mainModel.listMedicationInScript=function(id){var instanceApi=mainApi.all("list-medication-in-script");return instanceApi.post({id:id})},mainModel.remove=function(data){var instanceApi=mainApi.all("remove");return instanceApi.post({data:data})},mainModel.byid=function(data){var instanceApi=mainApi.all("byid");return instanceApi.post({data:data})},mainModel.postDisable=function(data){var instanceApi=mainApi.all("disable");return instanceApi.post({data:data})},mainModel.postSing=function(data){var instanceApi=mainApi.all("signature");return instanceApi.post({data:data})},mainModel.postScriptHead=function(data){var instanceApi=mainApi.all("addScriptHead");return instanceApi.post({data:data})},mainModel.listpostHead=function(data,datar){var instanceApi=mainApi.all("listscriptHead");return instanceApi.post({data:data,datar:datar})},mainModel.editHead=function(data,datar){var instanceApi=mainApi.all("editcriptHead");return instanceApi.post({data:data,datar:datar})},mainModel}),angular.module("app.loggedIn.script.directive.list",[]).directive("scriptList",function(ScriptModel,PatientService,$modal,$filter,$stateParams,$state,toastr){return{restrict:"EA",templateUrl:"modules/script/directives/templates/list.html",scope:{options:"=",limit:"@",medicare:"="},link:function(scope,ele,attrs){var search={page:1,limit:5,offset:0,max_size:5,Patient_id:$stateParams.patient_id,CAL_ID:$stateParams.cal_id},load=function(){ScriptModel.list(search).then(function(response){scope.script.list=response.data,scope.script.count=response.count},function(error){})},onSearch=function(option){switch(option.field){case"scriptNum":scope.script.search.scriptNum=option.value;break;case"medication_name":scope.script.search.medication_name=option.value}scope.script.load()},remove=function(id){var modalInstance=$modal.open({templateUrl:"notifyToRemove",controller:function($scope,id,$modalInstance){$scope.ok=function(){$modalInstance.close(id)},$scope.cancel=function(){$modalInstance.dismiss("cancel")}},size:"sm",resolve:{id:function(){return id}}});modalInstance.result.then(function(id){id&&ScriptModel.remove(id).then(function(deleted){toastr.success("Deleted Successfully"),scope.script.load()},function(error){})})};scope.Scripts=function(type,index){if("new"==type){$modal.open({templateUrl:"notifyToAdd",controller:function($scope,$modalInstance,medicare){$scope.medicare=medicare,$scope.cancel=function(){$modalInstance.dismiss("cancel")},$scope.success={runWhenFinish:function(){$modalInstance.dismiss({status:"success"})}}},size:"lg",resolve:{medicare:function(){return scope.medicare}}}).result.then(function(response){},function(response){"success"==response.status&&scope.script.load()})}if("edit"==type){$modal.open({templateUrl:"notifyToEdit",controller:function($scope,$modalInstance,medicare,idScript){$scope.medicare=medicare,$scope.idScript=idScript,$scope.cancel=function(){$modalInstance.dismiss("cancel")},$scope.success={runWhenFinish:function(){$modalInstance.dismiss({status:"success"})}}},size:"lg",resolve:{idScript:function(){return index},medicare:function(){return scope.medicare}}}).result.then(function(response){},function(response){"success"==response.status&&scope.script.load()})}};var disable=function(row){ScriptModel.postDisable(row).then(function(response){scope.script.load()},function(error){})};scope.setPage=function(page){scope.script.search.offset=(page-1)*scope.script.search.limit,scope.script.load()},scope.script={search:search,dialog:{remove:function(id){remove(id)}},loading:!1,list:[],count:0,error:"",disable:function(row){disable(row)},load:function(){load()},onSearch:function(option){onSearch(option)}},scope.script.load()}}}),angular.module("app.loggedIn.script.directive.add",[]).directive("scriptAdd",function(ScriptModel,PatientService,OutreferralModel,AppointmentModel,ConfigService,toastr,$cookieStore,$filter,$state,$stateParams,$modal){return{restrict:"EA",templateUrl:"modules/script/directives/templates/add.html",scope:{options:"=",success:"=",medicare:"="},link:function(scope,ele,attrs){var user_id=$cookieStore.get("userInfo").id,submitScript=function(){ConfigService.beforeSave(scope.script.errors),scope.script.errors=[],ScriptModel.add(scope.script.info).then(function(response){toastr.success("Add Successfully"),"success"==data.status&&scope.success&&scope.success.runWhenFinish()},function(error){scope.script.errors=angular.copy(error.data.errors),ConfigService.beforeError(scope.script.errors)})},getPatientInfo=function(){PatientService.getP($stateParams.patient_id).then(function(response){scope.patientData.info=response.data[0]},function(error){})};scope.patientData={info:{},getPatientInfo:function(){getPatientInfo()}};var getDoctorname=function(){OutreferralModel.DotorFromUserId(user_id).then(function(response){scope.script.info.prescriber=response.data[0].NAME,scope.script.info.doctorSign=response.data[0].Signature},function(error){})};scope.script={getDoctorname:function(){getDoctorname()},submitScript:function(params){submitScript(params)},errors:[],info:{ID:null,Patient_id:$stateParams.patient_id,CAL_ID:$stateParams.cal_id,prescriber:"",scriptNum:null,isRefNo:0,EntitlementNo:"",isSafety:0,isConcessional:0,isPBS:0,isRPBS:0,isBrand:0,MedicareNo:null,doctorSign:"",doctordate:moment().format("DD/MM/YYYY"),patientSign:"",patientDate:moment().format("DD/MM/YYYY"),agentAddress:"",medicare:[]}},scope.medicare&&(scope.script.info.medicare=angular.copy(scope.medicare)),scope.patientData.getPatientInfo(),scope.script.getDoctorname()}}}),angular.module("app.loggedIn.script.directive.edit",[]).directive("scriptEdit",function(ScriptModel,PatientService,ConfigService,$cookieStore,$filter,$state,$stateParams,toastr){return{restrict:"EA",templateUrl:"modules/script/directives/templates/edit.html",scope:{options:"=",success:"=",id:"=",medicare:"="},controller:function($scope){var getPatientInfo=($cookieStore.get("userInfo").id,function(){PatientService.getP($stateParams.patient_id).then(function(response){$scope.patientData.info=response.data[0]},function(error){})});$scope.patientData={info:{},getPatientInfo:function(){getPatientInfo()}};var loadInfo=function(){ScriptModel.byid($scope.id).then(function(response){response.data.doctordate=moment(response.data.doctordate).format("DD/MM/YYYY"),response.data.patientDate=moment(response.data.patientDate).format("DD/MM/YYYY"),$scope.scriptData.info=response.data,$scope.medicare&&($scope.scriptData.info.medicare=angular.copy($scope.medicare),ScriptModel.listMedicationInScript($scope.id).then(function(data){if("success"==data.status){var medicareInScript=[];_.forEach(data.data,function(item){medicareInScript[item.id_medicare]=item.id_medicare}),_.forEach($scope.scriptData.info.medicare,function(item){medicareInScript[item.id]&&(item.Checked=1)})}}))},function(error){})},saveScript=function(){ConfigService.beforeSave($scope.scriptData.errors),$scope.scriptData.errors=[],console.log("$scope.scriptData.info",$scope.scriptData.info),ScriptModel.add($scope.scriptData.info).then(function(response){toastr.success("Edited Successfully"),"success"==data.status&&$scope.success&&$scope.success.runWhenFinish()},function(error){$scope.scriptData.errors=angular.copy(error.data.errors),ConfigService.beforeError($scope.scriptData.errors)})};$scope.scriptData={saveScript:function(){saveScript()},errors:[],loadInfo:function(){loadInfo()},info:{ID:$scope.id,Patient_id:$stateParams.patient_id,CAL_ID:$stateParams.cal_id,prescriber:"",scriptNum:0,isRefNo:0,EntitlementNo:"",isSafety:0,isConcessional:0,isPBS:0,isRPBS:0,isBrand:0,pharmacist:"",doctorSign:"",doctordate:"",patientSign:"",patientDate:"",medicare:[]}},$scope.patientData.getPatientInfo(),$scope.scriptData.loadInfo()}}});