angular.module("app.loggedIn.mdtoutreferral",["app.loggedIn.mdtoutreferral.directives","app.loggedIn.mdtoutreferral.services"]),angular.module("app.loggedIn.mdtoutreferral.services",[]).factory("mdtoutreferralService",function(Restangular){var mdtService={},mdtApi=Restangular.all("api/meditek/v1/mdtoutreferral/");return mdtService.add=function(postData){var funcApi=mdtApi.all("add");return funcApi.post({add_data:postData})},mdtService.edit=function(id,postData){var funcApi=mdtApi.all("edit");return funcApi.post({edit_data:postData,edit_id:id})},mdtService.byId=function(id){var funcApi=mdtApi.all("byId");return funcApi.post({detail_id:id})},mdtService.search=function(option){var funcApi=mdtApi.all("search");return funcApi.post(option)},mdtService}),angular.module("app.loggedIn.mdtoutreferral.directives",["app.loggedIn.mdtoutreferral.detail.directive","app.loggedIn.mdtoutreferral.search.directive"]),angular.module("app.loggedIn.mdtoutreferral.detail.directive",[]).directive("mdtoutreferralDetail",function(mdtoutreferralModel,mdtDoctorService,mdtOutdoctorService,ConfigService,mdtoutreferralService,toastr,$cookieStore,$state,$stateParams){return{restrict:"EA",scope:{options:"=",params:"=",isClose:"@",itemUpdate:"="},templateUrl:"modules/mdtoutreferral/directives/templates/detail.html",link:function(scope,element,attrs){scope.closePopup=function(){angular.element("#"+scope.isClose).fadeOut()},scope.module_id={doctor:"DoctorModule",referred_doctor:"DoctorReferredModule"},scope.module_id_edit={doctor:"DoctorEditModule",referred_doctor:"DoctorReferredEditModule"},scope.$watch("params.id",function(newId,oldId){scope.params.permission.edit===!0&&"undefined"!=typeof newId&&0!==newId&&mdtoutreferralService.byId(newId).then(function(response){"error"==response.status&&toastr.error("Error Get Detail","Error"),angular.extend(scope.mdtoutreferralMap,response.data);for(var key in scope.mdtoutreferralMap)scope.mdtoutreferralMap[key]&&((-1!=key.indexOf("is")||-1!=key.indexOf("Is")||-1!=key.indexOf("IS"))&&(scope.mdtoutreferralMap[key]=scope.mdtoutreferralMap[key].toString()),(-1!=key.indexOf("date")||-1!=key.indexOf("Date")||-1!=key.indexOf("DATE"))&&(scope.mdtoutreferralMap[key]=new Date(scope.mdtoutreferralMap[key])),scope.mdtoutreferralMap.last_updated_by=$cookieStore.get("userInfo").id);mdtDoctorService.byId(scope.mdtoutreferralMap.referred_to_doctor).then(function(response){scope.selectedReferredDoctor=response.data}),mdtOutdoctorService.byId(scope.mdtoutreferralMap.doctor_id).then(function(response){scope.selectedDoctor=response.data})})});var init=function(){scope.isSubmit=!1,scope.mdtoutreferralMap=angular.copy(mdtoutreferralModel),scope.mdtoutreferralMap.patient_id=$stateParams.patient_id,scope.mdtoutreferralMap.created_by=$cookieStore.get("userInfo").id,scope.mdtoutreferralMap.last_updated_by=$cookieStore.get("userInfo").id,scope.isClose&&scope.closePopup(),scope.selectedReferredDoctor={NAME:"Select Referred Doctor"},scope.selectedDoctor={name:"Select Doctor"}};init(),scope.clickReferredDoctor=function(){scope.params.permission.edit===!0?angular.element("#"+scope.module_id_edit.referred_doctor).fadeIn():angular.element("#"+scope.module_id.referred_doctor).fadeIn()},scope.selectReferredDoctor=function(row){scope.selectedReferredDoctor=row,scope.params.permission.edit===!0?angular.element("#"+scope.module_id_edit.referred_doctor).fadeOut():angular.element("#"+scope.module_id.referred_doctor).fadeOut()},scope.clickDoctor=function(){scope.params.permission.edit===!0?angular.element("#"+scope.module_id_edit.doctor).fadeIn():angular.element("#"+scope.module_id.doctor).fadeIn()},scope.selectDoctor=function(row){scope.selectedDoctor=row,scope.params.permission.edit===!0?angular.element("#"+scope.module_id_edit.doctor).fadeOut():angular.element("#"+scope.module_id.doctor).fadeOut()},scope.clickAction=function(){if(scope.isSubmit=!0,scope.mdtoutreferralForm.$invalid)toastr.error("You got some fields left","Error");else{var postData=angular.copy(scope.mdtoutreferralMap);for(var key in postData)postData[key]instanceof Date&&(postData[key]=ConfigService.getCommonDate(postData[key]));postData.referred_to_doctor=scope.selectedReferredDoctor.doctor_id,postData.doctor_id=scope.selectedDoctor.doctor_id,postData.last_update_date=ConfigService.getCommonDatetime(new Date),scope.params.permission.edit===!0?mdtoutreferralService.edit(scope.params.id,postData).then(function(response){"error"==response.status&&toastr.error("Error Get Detail","Error"),init(),scope.itemUpdate=!0,toastr.success("Edit Successfully !!!","Success")}):(postData.creation_date=ConfigService.getCommonDatetime(new Date),mdtoutreferralService.add(postData).then(function(data){"error"==data.status&&toastr.error("Cannot Insert","Error"),toastr.success("Insert Successfully !!!","Success"),init(),scope.itemUpdate=!0}))}}}}}),angular.module("app.loggedIn.mdtoutreferral.search.directive",[]).directive("mdtoutreferralSearch",function(mdtoutreferralService,toastr,ConfigService){return{restrict:"EA",scope:{clickRow:"&"},templateUrl:"modules/mdtoutreferral/directives/templates/search.html",link:function(scope,element,attrs){var init=function(){scope.list={},scope.params={pagination:{limit:5,offset:0,current_page:1,max_size:3},filters:[{type:"text",name:"date_issued",value:""},{type:"text",name:"date_started",value:""},{type:"text",name:"duration",value:""}],select:["id","date_issued","date_started","expire_date","duration"]}},loadList=function(){mdtoutreferralService.search(scope.params).then(function(response){"error"===response.status&&toastr.error("Cannot get Seacrh","Error"),scope.list=response;for(var i=0;i<scope.list.data.length;i++)scope.list.data[i].date_issued_map=ConfigService.getCommonDateDefault(scope.list.data[i].date_issued),scope.list.data[i].expire_date_map=ConfigService.getCommonDateDefault(scope.list.data[i].expire_date)})};init(),loadList(),scope.setPage=function(){scope.params.pagination.offset=(scope.params.pagination.current_page-1)*scope.params.pagination.limit,loadList()}}}});