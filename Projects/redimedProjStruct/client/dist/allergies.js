angular.module("app.loggedIn.allergy",["app.loggedIn.allergy.controller","app.loggedIn.allergy.service","app.loggedIn.allergy.directive"]).config(function($stateProvider){$stateProvider.state("loggedIn.allergy",{url:"/allergy","abstract":!0,templateUrl:"modules/allergies/views/structure.html",controller:"AllergyController"}).state("loggedIn.patient.allergy",{"abstract":!0,views:{"main-content@loggedIn.patient":{templateUrl:"modules/allergies/views/structure.html",controller:"AllergyController"}}}).state("loggedIn.allergy.list",{url:"/list",views:{"main-content":{templateUrl:"modules/allergies/views/list.html",controller:"AllergyListController"}}}).state("loggedIn.patient.allergy.list",{url:"/allergy",views:{"main-content":{templateUrl:"modules/allergies/views/list.html",controller:"AllergyListController"}}})}),angular.module("app.loggedIn.allergy.controller",["app.loggedIn.allergy.list.controller"]).controller("AllergyController",function(){}),angular.module("app.loggedIn.allergy.list.controller",[]).controller("AllergyListController",function($scope,$stateParams,AllergyService,toastr){$scope.allergy_panel={},console.log("this is patient_id",$stateParams.patient_id),$stateParams.patient_id&&($scope.showAddExisted=!0);$scope.allergy={select:0,scope:$scope.patient_panel,options:{method:"post",scope:$scope.allergy_panel,columns:[{field:"allergy_id",is_hide:!0},{field:"allergy_name",label:"Allergy Name"},{field:"isEnable",is_hide:!0}],use_filters:!0,filters:{allergy_name:{type:"text"}},use_actions:!0,actions:[{"class":"fa fa-info",title:"Edit",callback:function(item){console.log("this is selected item",item),$scope.allergy.id=item.allergy_id,$scope.allergyEditForm.open()}}],actionsIsEnable:{show:!0,setEnable:function(item){item.isEnable=0==item.isEnable?1:0,console.log(item),AllergyService.update(item).then(function(data){(data.status="success")&&($scope.setListAllergy&&$scope.setListAllergy(),$scope.allergy_panel.reload())})}}}},$stateParams.patient_id?($scope.allergy.options.api="api/erm/v2/allergy/search_patient_allergy",$scope.allergy.options.search={Patient_id:$stateParams.patient_id}):$scope.allergy.options.api="api/erm/v2/allergy/search",$scope.allergySub=angular.copy($scope.allergy),$scope.allergyAddForm={is_show:!1,open:function(){this.is_show=!0},close:function(){this.is_show=!1},success:function(response){"success"==response.status&&$scope.setListAllergy&&$scope.setListAllergy(),$scope.allergy_panel.reload(),$scope.allergyAddForm.close()}},$scope.allergyEditForm={is_show:!1,open:function(){this.is_show=!0},close:function(){this.is_show=!1},success:function(response){"success"==response.status&&$scope.setListAllergy&&$scope.setListAllergy(),$scope.allergy_panel.reload(),$scope.allergyEditForm.close()}},$scope.patientAllergyForm={is_show:!1,open:function(){$scope.allergySub.options.use_actions=!1,$scope.allergySub.options.columns=[{field:"allergy_id",is_hide:!0},{field:"allergy_name",label:"Allergy name"},{field:"Creation_date",label:"Created date"}],$scope.allergySub.options.api="api/erm/v2/allergy/search_remain_allergy",this.is_show=!0},close:function(){this.is_show=!1},success:function(response){"success"==response.status&&$scope.allergy_panel.reload(),$scope.patientAllergyForm.close()}},$scope.allergySelected=function(item){console.log("this is selected item",item);var postData={allergy_id:item.allergy_id,patient_id:$stateParams.patient_id};AllergyService.insertPatientAllergy(postData).then(function(response2){"success"===response2.status?(toastr.success("Allergy applied to patient","Successfully"),$scope.setListAllergy&&$scope.setListAllergy(),$scope.patientAllergyForm.close(),$scope.allergy_panel.reload()):toastr.error("Fail to apply allergy to patient","Error")})}}),angular.module("app.loggedIn.allergy.service",[]).factory("AllergyService",function(Restangular,ConfigService,$state){var instanceService={},v2_api=Restangular.all("api/erm/v2");return instanceService.insert=function(postData){var detailApi=v2_api.all("allergy/insert");return detailApi.post(postData)},instanceService.detail=function(postData){var detailApi=v2_api.all("allergy/detail");return detailApi.post({ID:postData})},instanceService.update=function(postData){var detailApi=v2_api.all("allergy/update");return detailApi.post(postData)},instanceService.insertPatientAllergy=function(postData){var detailApi=v2_api.all("allergy/insert_patient_allergy");return detailApi.post(postData)},instanceService}),angular.module("app.loggedIn.allergy.directive",["app.loggedIn.allergy.detail.directive"]),angular.module("app.loggedIn.allergy.detail.directive",[]).directive("allergyDetail",function(AllergyModel,AllergyService,ConfigService,toastr,$stateParams){return{restrict:"EA",scope:{data:"@",options:"=",onsuccess:"=onsuccess"},templateUrl:"modules/allergies/directives/templates/detail.html",link:function(scope,element,attrs){var loadData=function(id){AllergyService.detail(id).then(function(data){angular.extend(scope.modelObjectMap,data.data),ConfigService.autoConvertData(scope.modelObjectMap)})};if(scope.modelObjectMap=angular.copy(AllergyModel),scope.mode={type:"add",text:"Add allergy"},scope.data){var data=scope.$eval(scope.data);data.id&&(loadData(data.id),scope.mode={type:"edit",text:"Edit referral"})}var addProcess=function(postData){AllergyService.insert(postData).then(function(response){if("success"===response.status)if($stateParams.patient_id){var postData={allergy_id:response.data.allergy_id,patient_id:$stateParams.patient_id};AllergyService.insertPatientAllergy(postData).then(function(response2){"success"===response2.status?(toastr.success("Successfully add and apllied allergy to patient","Successfully"),scope.modelObjectMap=angular.copy(AllergyModel),scope.isSubmit=!1,scope.onsuccess&&scope.onsuccess(response)):toastr.error("Allergy add successfully but fail to apply allergy to patient","Error")})}else toastr.success("Add allergy successfully","Successfully"),scope.modelObjectMap=angular.copy(AllergyModel),scope.isSubmit=!1,scope.onsuccess&&scope.onsuccess(response);else toastr.error("Fail to add allergy","Error")})},editProcess=function(postData){AllergyService.update(postData).then(function(response){"success"===response.status&&(toastr.success("Edit allergy Successfully","Success"),scope.isSubmit=!1,scope.onsuccess&&scope.onsuccess(response))})};scope.clickAction=function(option){if("view"!=option.type&&(scope.isSubmit=!0,!scope.mainForm.$invalid)){var postData=angular.copy(scope.modelObjectMap);for(var key in postData)postData[key]instanceof Date&&(postData[key]=ConfigService.getCommonDate(postData[key]));"add"==option.type?addProcess(postData):"edit"==option.type&&editProcess(postData)}}}}});