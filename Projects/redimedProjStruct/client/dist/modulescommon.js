angular.module("app.directive.common",["app.directive.mydatatable.common","app.directive.smartfloat.common"]).filter("offset",function(){return function(input,start){return input.length>0?(start=20*(start-1),input.slice(start,start+20)):void 0}}).filter("undefined",function(){return function(input){return input&&""!==input&&null!==input?input:"No"}}).filter("arrGetBy",function(){return function(input,key,value){for(var i=0,len=input.length;len>i;i++)if(input[i][key]==value)return input[i];return null}}).filter("startFrom",function(){return function(input,start){return start=+start,input?input.slice(start):input}}).filter("moment",function(){return function(input,momentFn){var args=Array.prototype.slice.call(arguments,2),momentObj=moment(input);return momentObj[momentFn].apply(momentObj,args)}}).directive("accessibleForm",function(){return{restrict:"A",link:function(scope,elem){elem.on("submit",function(){var f1=angular.element(elem[0].querySelectorAll(".ng-invalid")[0]),f2=angular.element(elem[0].querySelectorAll(".ng-invalid")[1]);void 0!=f1[0]&&void 0==f2[0]?f1.focus():void 0!=f2[0]&&f1[0].childElementCount>0?f2.focus():void 0!=f2[0]&&f1[0].childElementCount<=0?f1.offset().top<f2.offset().top?f1.focus():f2.focus():0})}}}).directive("fabric",function(){return{restrict:"EA",templateUrl:"common/views/directives/fabric.html",link:function(scope,element,attrs){{var canvas=new fabric.Canvas("c"),text=new fabric.Text("hello world",{fontSize:30,originX:"center",originY:"center"});new fabric.Group([text],{left:150,top:100,angle:-10})}canvas.add(text)}}}).directive("tooltip",function(){return{restrict:"A",link:function(scope,element,attrs){$(element).hover(function(){$(element).tooltip("show")},function(){$(element).tooltip("hide")})}}}).directive("bootstrapSwitch",[function(){return{restrict:"A",require:"?ngModel",link:function(scope,element,attrs,ngModel){element.bootstrapSwitch(),element.on("switchChange.bootstrapSwitch",function(event,state){ngModel&&scope.$apply(function(){ngModel.$setViewValue(state)})}),scope.$watch(attrs.ngModel,function(newValue,oldValue){newValue?element.bootstrapSwitch("state",!0,!0):element.bootstrapSwitch("state",!1,!0)})}}}]).directive("audiogram",function($timeout){return{restrict:"EA",scope:{data:"="},templateUrl:"common/views/directives/audioDiagram.html",link:function(scope,element,attrs){scope.id=attrs.audiogram,scope.$watch("data",function(newData){for(var data=newData,WIDTH=800,HEIGHT=430,MARGIN=40,xOffset=30,yOffset=100,groupAxisXData=[-10,0,10,20,30,40,50,60,70,80,90,100,110,120],WIDTH=data.length*yOffset+yOffset,paper=Raphael(scope.id,1e3,600),offset=(paper.path(["M",MARGIN,MARGIN,"L",WIDTH+MARGIN,MARGIN,"L",WIDTH+MARGIN,HEIGHT,"L",MARGIN,HEIGHT,"L",MARGIN,MARGIN]),MARGIN),i=0;i<groupAxisXData.length;++i)paper.text(MARGIN/2,offset,groupAxisXData[i]),offset+=xOffset,i<groupAxisXData.length-2&&paper.path(["M",MARGIN,offset,"L",WIDTH+MARGIN,offset]);for(var offset=yOffset+MARGIN,i=0;i<data.length;++i)paper.text(offset,MARGIN/2,data[i]+"Hz"),paper.path(["M",offset,MARGIN,"L",offset,HEIGHT]),offset+=i===data.length-1?2*yOffset:yOffset})}}}).directive("numbersOnly",function(){return{require:"ngModel",scope:{model:"=ngModel"},link:function(scope,element,attrs,modelCtrl){scope.$watch("model",function(newValue,oldValue){var arr=String(newValue).split("");0!==arr.length&&(1!==arr.length||"-"!=arr[0]&&"."!==arr[0])&&(2!==arr.length||"-."!==newValue)&&isNaN(newValue)&&(scope.model=oldValue)}),element.bind("keypress",function(event){32===event.keyCode&&event.preventDefault()})}}}).directive("radio",function(){return{restrict:"A",require:"?ngModel",scope:{model:"=ngModel",value:"=ngValue"},link:function(scope,element,attrs){element.uniform(),scope.$watch("model",function(model){model&&(model===scope.value&&element.prop("checked",!0),angular.element.uniform.update(element))})}}}).directive("checkbox",function(){return{restrict:"A",require:"?ngModel",scope:{model:"=ngModel"},link:function(scope,element,attrs){element.uniform(),scope.$watch("model",function(model){model&&(element.prop("checked",!0),angular.element.uniform.update(element))})}}}).directive("minHeight",function(){return{restrict:"A",link:function(scope,element,attrs){var windowHeight=angular.element(window).height();element.css("min-height",windowHeight+"px"),angular.element(window).resize(function(){var windowHeight=angular.element(window).height();element.css("min-height",windowHeight+"px")})}}}).directive("knob",function(){return{restrict:"A",link:function(scope,element,attrs){$(element).val(scope.number).knob()}}}).directive("syncClick",function(){return{restrict:"A",scope:{syncClick:"&"},link:function(scope,element,attrs){element.on("click",function(){scope.syncClick()})}}}).directive("draggable",function($document,$timeout){var getEventProp=function(event,prop){return event[prop]||event.touches&&event.touches[0][prop]||event.originalEvent&&event.originalEvent.touches&&event.originalEvent.touches[0][prop]};return{restrict:"A",scope:{drag:"="},link:function(scope,element,attr){scope.$watch("drag",function(val){if(void 0!==val&&1==val)console.log("=========A============");else{console.log("=========B=============");var mouseMoveHandler=function(event){y=getEventProp(event,"pageY")-startY,x=getEventProp(event,"pageX")-startX,element.css({top:y+"px",left:x+"px"})},mouseUpHandler=function mouseUpHandler(event){$document.unbind("mousemove touchmove",mouseMoveHandler),$document.unbind("mouseup touchend",mouseUpHandler)},position=element.css("position"),startX=0,startY=0,x=0,y=0;"relative"!==position&&"absolute"!==position&&(element.css("positon","relative"),position="relative"),element.on("mousedown touchstart",function(event){event.preventDefault();var pageX=getEventProp(event,"pageX"),pageY=getEventProp(event,"pageY");startX=pageX-element.context.offsetLeft,startY=pageY-element.context.offsetTop,$document.on("mousemove touchmove",mouseMoveHandler),$document.on("mouseup touchend",mouseUpHandler),$($document[0].body).on("mouseleave",mouseUpHandler)})}})}}}).directive("customDate",function(){return{restrict:"A",link:function(scope,element,attrs){var defaultDate="dd/mm/yy";element.datepicker("birthday"===attrs.type?{dateFormat:defaultDate,changeMonth:!0,changeYear:!0,defaultDate:new Date(1990,8,6),yearRange:"1930:2100"}:{dateFormat:defaultDate,changeMonth:!0,changeYear:!0})}}}).directive("checkList",function(){return{restrict:"A",scope:{selectedItemsArray:"=",value:"@"},link:function(scope,elem){scope.$watchCollection("selectedItemsArray",function(newValue){_.contains(newValue,scope.value)?elem.prop("checked",!0):elem.prop("checked",!1)}),_.contains(scope.selectedItemsArray,scope.value)&&elem.prop("checked",!0),elem.on("change",function(){if(elem.prop("checked"))_.contains(scope.selectedItemsArray,scope.value)||scope.$apply(function(){scope.selectedItemsArray.push(scope.value)});else if(_.contains(scope.selectedItemsArray,scope.value)){var index=scope.selectedItemsArray.indexOf(scope.value);scope.$apply(function(){scope.selectedItemsArray.splice(index,1)})}})}}}).directive("sidebarRes",function(){return{restrict:"A",link:function(scope,element,attrs){var windowWidth=angular.element(window).width();768>windowWidth?(element.find(".not-mobile").hide(),element.find(".mobile").show(),element.addClass("sidebar-mobile"),element.find("#main-menu").hide(),element.find(".sidebar-menu").css("min-height","0px"),element.find(".sidebar-menu").addClass("sidebar-mobile"),element.find(".sidebar-menu").css("position","relative"),element.addClass("sidebar-padding-left"),element.removeClass("sidebar-collapsed")):992>windowWidth?(element.find(".not-mobile").show(),element.find(".mobile").hide(),element.find("#main-menu").show(),element.addClass("sidebar-collapsed"),element.removeClass("sidebar-mobile"),element.find(".sidebar-menu").removeClass("sidebar-mobile"),element.find(".sidebar-menu").css("position","absolute"),element.removeClass("sidebar-padding-left")):(element.find(".not-mobile").show(),element.find(".mobile").hide(),element.find("#main-menu").show(),element.removeClass("sidebar-collapsed"),element.removeClass("sidebar-mobile"),element.find(".sidebar-menu").removeClass("sidebar-mobile"),element.find(".sidebar-menu").css("position","absolute"),element.removeClass("sidebar-padding-left")),angular.element(window).resize(function(){var windowWidth=angular.element(window).width();768>windowWidth?(element.find(".not-mobile").hide(),element.find(".mobile").show(),element.addClass("sidebar-mobile"),element.find("#main-menu").hide(),element.find(".sidebar-menu").css("min-height","0px"),element.find(".sidebar-menu").css("position","relative"),element.addClass("sidebar-padding-left"),element.removeClass("sidebar-collapsed")):992>windowWidth?(element.find(".not-mobile").show(),element.find(".mobile").hide(),element.find("#main-menu").show(),element.addClass("sidebar-collapsed"),element.removeClass("sidebar-mobile"),element.find(".sidebar-menu").removeClass("sidebar-mobile"),element.find(".sidebar-menu").css("position","absolute"),element.removeClass("sidebar-padding-left")):(element.find(".not-mobile").show(),element.find(".mobile").hide(),element.find("#main-menu").show(),element.removeClass("sidebar-collapsed"),element.removeClass("sidebar-mobile"),element.find(".sidebar-menu").removeClass("sidebar-mobile"),element.find(".sidebar-menu").css("position","absolute"),element.removeClass("sidebar-padding-left"))})}}}).directive("email",function(){return{require:"ngModel",link:function(scope,element,attrs,ctrl){ctrl.$parsers.unshift(function(email){var re=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return"undefined"!=typeof email&&""!==email?re.test(email)?ctrl.$setValidity("email",!0):ctrl.$setValidity("email",!1):ctrl.$setValidity("email",!0),email})}}}).directive("integer",function(){return{require:"ngModel",link:function(scope,element,attrs,ctrl){ctrl.$parsers.unshift(function(number){return"undefined"!=typeof number&&""!==number&&null!==number?number>=0&&number%1===0?ctrl.$setValidity("integer",!0):ctrl.$setValidity("integer",!1):ctrl.$setValidity("integer",!0),number})}}}).directive("ngLoading",function($compile){return{restrict:"A",scope:!1,link:function(scope,element,attrs){var initialContents=element.html();scope.$watch(attrs.ngLoading,function(loading){loading===!0?element.html('<div class="loading-circles"><div class="loading-circle"></div><div class="loading-circle"></div><div class="loading-circle"></div><div class="loading-circle"></div><div class="loading-circle"></div><div class="loading-circle"></div><div class="loading-circle"></div><div class="loading-circle"></div></div>'):(element.html(initialContents),$compile(element.contents())(scope))})}}}).directive("match",function(){return{require:"ngModel",restrict:"A",scope:{match:"="},link:function(scope,elem,attrs,ctrl){scope.$watch(function(){var modelValue=ctrl.$modelValue||ctrl.$$invalidModelValue;return ctrl.$pristine&&angular.isUndefined(modelValue)||scope.match===modelValue},function(currentValue){ctrl.$setValidity("match",currentValue)})}}}).directive("appFilereader",function($q){var slice=Array.prototype.slice;return{restrict:"A",require:"?ngModel",link:function(scope,element,attrs,ngModel){ngModel&&(ngModel.$render=function(){},element.bind("change",function(e){function readFile(file){var deferred=$q.defer(),reader=new FileReader;return reader.onload=function(e){deferred.resolve(e.target.result)},reader.onerror=function(e){deferred.reject(e)},reader.readAsDataURL(file),deferred.promise}var element=e.target;$q.all(slice.call(element.files,0).map(readFile)).then(function(values){ngModel.$setViewValue(element.multiple?values:values.length?values[0]:null)})}))}}}).directive("pwCheck",[function(){return{require:"ngModel",link:function(scope,elem,attrs,ctrl){var firstPassword="#"+attrs.pwCheck;elem.add(firstPassword).on("keyup",function(){scope.$apply(function(){var v=elem.val()===$(firstPassword).val();ctrl.$setValidity("pwmatch",v)})})}}}]).directive("customTimepicker",function(){return{require:"ngModel",restrict:"EA",scope:{ngModel:"="},link:function(scope,elem,attrs,ctrl){elem.timepicker({showPeriodLabels:!1,onSelect:function(time,inst){scope.ngModel=time,scope.$apply()}})}}}).directive("ngRightClick",function($parse){return function(scope,element,attrs){var fn=$parse(attrs.ngRightClick);element.bind("contextmenu",function(event){scope.$apply(function(){event.preventDefault(),fn(scope,{$event:event})})})}}).directive("floatLabel",function(){return{require:"ngModel",restrict:"A",scope:{ngModel:"="},link:function(scope,element,attrs){"timepicker"===attrs.type&&element.timepicker({showPeriodLabels:!1,onSelect:function(time,inst){scope.ngModel=time,scope.$apply()}}),scope.$watch("ngModel",function(newModel,oldModel){"undefined"==typeof newModel||""===newModel||null===newModel?element.parent().removeClass("show-label"):(element.parent().addClass("show-label"),attrs.toDate?angular.element("#"+attrs.toDate).datepicker("option","minDate",scope.ngModel):attrs.fromDate&&angular.element("#"+attrs.fromDate).datepicker("option","maxDate",scope.ngModel))})}}}).directive("signature",function($timeout){return{restrict:"A",require:"ngModel",scope:{ngModel:"=",reset:"="},link:function(scope,element,attr){var canvas=document.querySelector("#"+attr.id),signaturePad=new SignaturePad(canvas);signaturePad.maxWidth=3,signaturePad.penColor="black",scope.$watch("ngModel",function(newModel){"undefined"!=typeof newModel&&(signaturePad.isEmpty()||signaturePad.clear(),signaturePad.fromDataURL(newModel))}),signaturePad.onEnd=function(){scope.$apply(function(){scope.ngModel=signaturePad.toDataURL()})}}}}).filter("utc",function(){return function(val){var date=new Date(val);return new Date(date.getUTCFullYear(),date.getUTCMonth(),date.getUTCDate(),date.getUTCHours(),date.getUTCMinutes(),date.getUTCSeconds())}}).filter("empty",function(){return function(input){return"undefined"!=typeof input&&input?input:"###"}}).filter("filterdate",function(){return function(input,date){return moment(input).isValid()&&("undefined"!=typeof input||input)?moment(input).format(date):"###"}}).directive("ngEnter",function(){return function(scope,element,attrs){element.bind("keydown keypress",function(event){13===event.which&&(scope.$apply(function(){scope.$eval(attrs.ngEnter)}),event.preventDefault())})}}).directive("customTr",function(){return{restrict:"EA",scope:{customTr:"=",customFr:"=",ngModel:"="},link:function(scope,elem,attrs){var arrayError={required:"Field is required!",maxlength:"Too long!",number:"Required number!"};scope.$watch("customTr",function(newModel,oldModel){var checkErr=!1;void 0!==scope.customFr&&void 0!==scope.customFr.$error&&null!==scope.customFr.$error&&(angular.forEach(scope.customFr.$error,function(err,index){err&&(checkErr=!0,elem.parent().hasClass("tooltipstered")&&angular.element(elem.parent()).tooltipster("destroy"),angular.element(elem.parent()).tooltipster({theme:"tooltip-error-theme",contentAsHTML:!0,content:arrayError[index]}))}),checkErr?(elem.parent().find("i").hasClass("glyphicon glyphicon-exclamation-sign")?elem.parent().find("i").hasClass("glyphicon glyphicon-exclamation-sign"):elem.parent().find("label").append("&nbsp<i class='glyphicon glyphicon-exclamation-sign' style='color: #f3565d'></i>"),elem.parent().find("label").css("color","#f3565d")):(elem.parent().find("i").hasClass("glyphicon glyphicon-exclamation-sign")&&elem.parent().find("i").hasClass("glyphicon glyphicon-exclamation-sign")&&elem.parent().find("i").removeClass("glyphicon glyphicon-exclamation-sign"),elem.parent().find("label").css("color","#404040"),elem.parent().hasClass("tooltipstered")&&(angular.element(elem.parent()).tooltipster("destroy"),angular.element(elem.parent()).removeAttr("title"))))})}}}),angular.module("app.directive.mydatatable.common",[]).directive("myDataTable",function(Restangular,ConfigService){return{restrict:"E",templateUrl:"common/views/mydatatable.html",scope:{options:"=options",row_click:"=rowclick",row_class:"=rowclass",num_rows:"=numrows",col_click:"=colclick"},controller:function($scope,$element,$attrs){var options=$scope.options;if(options){$scope.search={};var getFields=function(){for(var fields=[],i=0,len=options.columns.length;len>i;++i){var item=options.columns[i];item.not_submit||fields.push(item.db_field?item.db_field:item.field)}return fields},getOrders=function(){for(var order=[],i=0,len=options.columns.length;len>i;++i){var col=options.columns[i];col.order&&order.push([col.field,col.order])}return console.log(order),order},processData=function(data){var oldTotal=$scope.page_data.totalItems;oldTotal!=data.count&&($scope.page_data.totalItems=data.count),$scope.data.items=data.list};$scope.ajaxGetData=function(){var limit=$scope.page_data.itemPerPage,offset=($scope.page_data.currentPage-1)*limit,fields=getFields(),orders=getOrders(),opt={limit:limit,offset:offset,fields:fields,order:orders};options.use_filters&&(opt.search=$scope.search),options.search&&(opt.search||(opt.search={}),angular.extend(opt.search,options.search)),options.method&&"post"==options.method.toLowerCase()?Restangular.all(options.api).post(opt).then(processData):Restangular.one(options.api).get(opt).then(processData)},$scope.orderField=function(col){col.order&&($scope.page_data.currentPage=1,col.order="ASC"==col.order?"DESC":"ASC",$scope.ajaxGetData())},$scope.enterFilter=function(){$scope.page_data.currentPage=1,$scope.ajaxGetData()},$scope.reload=function(){$scope.ajaxGetData(),$scope.data.more_items=[]},$scope.displayData=function(data,col){return col.format?col.format(data):data};var init=function(){$scope.data={more_items:[],items:[]},$scope.search={},$scope.limit_opt=[{value:5},{value:10},{value:20},{value:50}],$scope.page_data={totalItems:0,currentPage:1,maxSize:5,itemPerPage:5},$scope.num_rows&&($scope.page_data.itemPerPage=$scope.num_rows),!options.not_load&&options.api&&$scope.ajaxGetData(),options.not_paging=options.not_paging?!0:!1,void 0!==options.scope&&null!==options.scope&&angular.extend(options.scope,$scope),$scope["static"]=options["static"]?!0:!1};init()}}}}),angular.module("app.directive.smartfloat.common",[]).directive("smartFloat",function($filter){var FLOAT_REGEXP_1=/^\$?\d+.(\d{3})*(\,\d*)$/,FLOAT_REGEXP_2=/^\$?\d+,(\d{3})*(\.\d*)$/,FLOAT_REGEXP_3=/^\$?\d+(\.\d*)?$/,FLOAT_REGEXP_4=/^\$?\d+(\,\d*)?$/;return{require:"ngModel",link:function(scope,elm,attrs,ctrl){ctrl.$parsers.unshift(function(viewValue){return FLOAT_REGEXP_1.test(viewValue)?(ctrl.$setValidity("float",!0),parseFloat(viewValue.replace(".","").replace(",","."))):FLOAT_REGEXP_2.test(viewValue)?(ctrl.$setValidity("float",!0),parseFloat(viewValue.replace(",",""))):FLOAT_REGEXP_3.test(viewValue)?(ctrl.$setValidity("float",!0),parseFloat(viewValue)):FLOAT_REGEXP_4.test(viewValue)?(ctrl.$setValidity("float",!0),parseFloat(viewValue.replace(",","."))):void ctrl.$setValidity("float",!1)}),ctrl.$formatters.unshift(function(modelValue){return $filter("number")(parseFloat(modelValue),2)})}}});