angular.module("app.loggedIn.receptionist",["app.loggedIn.receptionist.controller","app.loggedIn.receptionist.services","app.loggedIn.receptionist.directives"]).config(function($stateProvider){$stateProvider.state("loggedIn.receptionist",{"abstract":!0,templateUrl:"modules/receptionist/views/structure.html",controller:"ReceptionistController"}).state("loggedIn.receptionist.home",{url:"/receptionist/home",views:{"main-content":{templateUrl:"modules/receptionist/views/home.html",controller:"ReceptionistHomeController"}}})}),angular.module("app.loggedIn.receptionist.services",[]).service("receptionStileService",function(){var receptionStile=null;this.getreceptionStile=function(){return receptionStile},this.setreceptionStile=function(site){receptionStile=JSON.parse(JSON.stringify(site))}}).factory("ReceptionistService",function(Restangular){var receptionistService={},ermApi=Restangular.all("api/erm"),restfulAPI=Restangular.all("api/restful");receptionistService.getAppointmentList=function(options){return ermApi.all("appointment/get").post(options)},receptionistService.getAppointmentOverview=function(options){return ermApi.all("appointment/overview").post(options)},receptionistService.booking=function(options){return ermApi.all("appointment/booking").post(options)},receptionistService.getById=function(id){return ermApi.all("appointment/getById").post({booking_id:id})},receptionistService.deleteBooking=function(options){return ermApi.all("appointment/delete").post(options)},receptionistService.updateBooking=function(options){return ermApi.all("appointment/update").post(options)},receptionistService.updateStatus=function(options){return ermApi.all("appointment/updateStatus").post(options)},receptionistService.apptDetail=function(cal_id){return ermApi.one("v2/appt/detail").get({id:cal_id})},receptionistService.getItemAppt=function(appt_id,patient_id){return ermApi.all("v1/appointment/get_items").post({appt_id:appt_id,patient_id:patient_id})},receptionistService.itemFeeAppt=function(service_id,list_id){return ermApi.all("v2/appt/item_fee_appt").post({service_id:service_id,list_id:list_id})},receptionistService.getReferral=function(appt_id,patient_id){return restfulAPI.one("Referral").get({CAL_ID:appt_id,patient_id:patient_id})};var receptionistApi=Restangular.all("api/receptionist");return receptionistService.getAppointmentByDate=function(date,site){return receptionistApi.all("appointment/getByDate").post({date:date,siteId:site})},receptionistService.getProgressAppt=function(date,site){return receptionistApi.all("appointment/progress").post({date:date,siteId:site})},receptionistService.updateAppointment=function(from,to,state){return receptionistApi.all("appointment/update").post({fromAppt:from,toAppt:to,state:state})},receptionistService.getSite=function(){return receptionistApi.one("getSites").get()},receptionistService}),angular.module("app.loggedIn.receptionist.directives",[]),angular.module("app.loggedIn.receptionist.controller",["app.loggedIn.receptionist.home.controller"]).controller("ReceptionistController",function($scope,ConfigService,ReceptionistService){}),angular.module("app.loggedIn.receptionist.home.controller",[]).controller("ReceptionistHomeController",function(AppointmentModel,$scope,$filter,$state,$timeout,$modal,socket,$cookieStore,toastr,ConfigService,DoctorService,ReceptionistService,PatientService,localStorageService,sysServiceService,receptionStileService,AppointmentModel){function getAppt(date,site){var d=moment(date).format("YYYY-MM-DD");$scope.upcomingAppt=[],$scope.progressAppt=[],$scope.completeAppt=[],$scope.injuryAppt=[],$scope.checkedAppt=[],$scope.doctors=[],loadAlertCenter(site),ReceptionistService.getAppointmentByDate(d,site).then(function(rs){"success"==rs.status.toLowerCase()&&($scope.upcomingAppt=rs.upcoming,$scope.completeAppt=rs.completed,$scope.injuryAppt=rs.injury,$scope.checkedAppt=rs.checkedIn,ReceptionistService.getProgressAppt(d,site).then(function(rs){"success"==rs.status.toLowerCase()&&($scope.progressAppt=rs.data,$scope.doctors=rs.doctorData)}))})}$scope.apptDate=new Date,$scope.apptSite=receptionStileService.getreceptionStile(),$scope.upcomingAppt=[],$scope.progressAppt=[],$scope.completeAppt=[],$scope.injuryAppt=[],$scope.checkedAppt=[],$scope.doctors=[],$scope.undoArr=[],$scope.fromAppt={},$scope.startCheckedTime=null,$scope.servicedata={},$scope.getServiceColor=function(){AppointmentModel.getServiceColor("data").then(function(response){$scope.servicedata=response.data},function(error){})},$scope.getServiceColor(),ReceptionistService.getSite().then(function(rs){"success"==rs.status?$scope.siteList=rs.data:toastr.error("Site Error!")}),$scope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams){receptionStileService.setreceptionStile($scope.apptSite)}),$scope.clickArrow=function(){$scope.alertCenter.arrow=!$scope.alertCenter.arrow,$scope.alertCenter.arrow?(angular.element("#alert-center").css({display:"none"}),angular.element(".un_arrow").css({right:0})):(angular.element("#alert-center").css({display:"block"}),angular.element(".un_arrow").css({right:"225px"}))};var loadAlertCenter=function(site){date=moment(new Date).format("YYYY-MM-DD");var postData={datepicker:date,site_id:site};$scope.alertCenter.list=[],AppointmentModel.alertSiteCenter(postData).then(function(response){_.forEach(response.data,function(row){var flag=-1,i=0;if(_.forEach($scope.alertCenter.list,function(list){return list.Patient_id===row.Patient_id?void(flag=i):void i++}),-1!==flag){if(row.ALERT_ID){var alert_flag=!0;if(_.forEach($scope.alertCenter.list[flag].alert,function(alert){alert.id===row.ALERT_ID&&(alert_flag=!1)}),alert_flag){var object={id:row.ALERT_ID,name:row.ALERT_NAME};$scope.alertCenter.list[flag].alert.push(object)}var cal_flag=!0,i=0;if(_.forEach($scope.alertCenter.list[flag].cal,function(cal){cal.CAL_ID===row.CAL_ID&&(cal_flag=!1)}),cal_flag&&($scope.alertCenter.list[flag].test=row.IS_REFERRAL,$scope.alertCenter.list[flag].cal.push({IS_REFERRAL:row.IS_REFERRAL,CAL_ID:row.CAL_ID,FROM_TIME:row.FROM_TIME,TO_TIME:row.TO_TIME,OUTREFERRAL:"no",DOCTOR_ID:row.DOCTOR_ID}),row.outreferral_id)){var cal_length=$scope.alertCenter.list[flag].cal.length;$scope.alertCenter.list[flag].cal[cal_length-1].OUTREFERRAL="yes"}}}else{var object={Patient_id:row.Patient_id,First_name:row.First_name,Sur_name:row.Sur_name,alert:[],cal:[]};row.ALERT_ID&&object.alert.push({id:row.ALERT_ID,name:row.ALERT_NAME}),row.CAL_ID&&(object.test=row.IS_REFERRAL,object.cal.push({IS_REFERRAL:row.IS_REFERRAL,DOCTOR_ID:row.DOCTOR_ID,CAL_ID:row.CAL_ID,FROM_TIME:row.FROM_TIME,TO_TIME:row.TO_TIME,OUTREFERRAL:"no"}),row.outreferral_id&&(object.cal[0].OUTREFERRAL="yes")),$scope.alertCenter.list.push(object)}})},function(error){})};$scope.alertCenter={load:function(){loadAlertCenter()},list:[],arrow:!1},loadAlertCenter(-1),$scope.getAppointment=function(){null==$scope.apptSite?(toastr.warning("Please Choose Site!"),$scope.upcomingAppt=[],$scope.progressAppt=[],$scope.completeAppt=[],$scope.injuryAppt=[],$scope.checkedAppt=[],$scope.doctors=[]):getAppt($scope.apptDate,$scope.apptSite)},getAppt($scope.apptDate,$scope.apptSite),$scope.openMap=function(){$modal.open({templateUrl:"modules/receptionist/views/modals/modalMap.html",controller:"InjuryMapController",size:"lg"})},$scope.changeAppt=function(appt,status){swal({title:"Are You Sure To Update This Appointment?",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes",closeOnConfirm:!0,closeOnCancel:!0},function(){ReceptionistService.updateAppointment(appt,appt,status).then(function(rs){"success"==rs.status&&toastr.success("Update Appointment Success!")}),getAppt($scope.apptDate,$scope.apptSite)})},$scope.dragAppt=function(event,ui,data){$scope.fromAppt=angular.copy(data)},$scope.dropAppt=function(event,ui,doctor){$scope.fromAppt&&swal({title:"Are You Sure To Set This Appointment?",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes",closeOnConfirm:!0,closeOnCancel:!0},function(isConfirm){if(isConfirm){var doctorId="undefined"!=typeof doctor.appointment&&doctor.appointment.length>0?doctor.appointment[0].doctor_id:doctor.doctor_id;ReceptionistService.updateAppointment($scope.fromAppt,doctorId,"progress").then(function(rs){"success"==rs.status&&(toastr.success("Update Appointment Success!"),socket.emit("notifyDoctor",doctorId),socket.emit("notifyPatient",$scope.fromAppt.appt_id),$scope.undoArr=[],$scope.undoArr.push($scope.fromAppt)),getAppt($scope.apptDate,$scope.apptSite)})}else getAppt($scope.apptDate,$scope.apptSite)})},socket.on("receiveNotifyReceptionist",function(){getAppt($scope.apptDate,$scope.apptSite)}),$scope.undoAction=function(){$scope.undoArr.length>0&&(console.log($scope.undoArr[0]),swal({title:"Are You Sure To Undo Action?",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes",closeOnConfirm:!0,closeOnCancel:!0},function(){ReceptionistService.updateAppointment($scope.undoArr[0],$scope.undoArr[0],"undo").then(function(rs){"success"==rs.status&&(toastr.success("Undo Action Success!"),$scope.undoArr=[])}),getAppt($scope.apptDate,$scope.apptSite)}))}});