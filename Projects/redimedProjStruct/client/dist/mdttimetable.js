angular.module("app.loggedIn.timetable_old",["app.loggedIn.timetable.directives","app.loggedIn.timetable.services"]),angular.module("app.loggedIn.timetable.services",[]).factory("mdtTimetableService",function(Restangular){var mdtService={},mdtApi=Restangular.all("api/meditek/v1/mdttimetable/");return mdtService.byDoctor=function(doctor_id){var funcApi=mdtApi.all("byDoctor");return funcApi.post({doctor_id:doctor_id})},mdtService.showWeek=function(doctor_id,cal_header_df_id){var funcApi=mdtApi.all("showWeek");return funcApi.post({doctor_id:doctor_id,cal_header_df_id:cal_header_df_id})},mdtService.addSite=function(doctor_id,cal_header_df_id,content){var funcApi=mdtApi.all("addSite");return funcApi.post({doctor_id:doctor_id,cal_header_df_id:cal_header_df_id,content:content})},mdtService.add=function(timetable,doctor_id){var funcApi=mdtApi.all("add");return funcApi.post({timetable:timetable,doctor_id:doctor_id})},mdtService.addRow=function(data){var funcApi=mdtApi.all("addRow");return funcApi.post(data)},mdtService.generate=function(doctor_id,interval,clinical_id){var funcApi=mdtApi.all("generate");return funcApi.post({doctor_id:doctor_id,interval:interval,clinical_id:clinical_id})},mdtService.remove=function(cal_id){var funcApi=mdtApi.all("remove");return funcApi.post({cal_id:cal_id})},mdtService.timetableRemove=function(cal_header_df_id){var funcApi=mdtApi.all("timetableRemove");return funcApi.post({cal_header_df_id:cal_header_df_id})},mdtService}),angular.module("app.loggedIn.timetable.directives",["app.loggedIn.timetable.main.directive"]),angular.module("app.loggedIn.timetable.main.directive",[]).directive("timetableGenerate",function(mdtTimetableService,mdtDoctorService,sysServiceService,mdtRedimedsitesService,ConfigService,toastr,$timeout){return{restrict:"EA",scope:{options:"=",doctorId:"="},templateUrl:"modules/mdttimetable/directives/templates/timetable.html",link:function(scope,element,attrs){scope.selectedDoctor={},scope.removeTimetable=function(data){mdtTimetableService.timetableRemove(data.cal_header_df_id).then(function(data){toastr.success("Remove Successfully"),init()})},mdtDoctorService.byId(scope.doctorId).then(function(response){scope.selectedDoctor=response.data,sysServiceService.byClinicalDepartment(response.data.CLINICAL_DEPT_ID).then(function(response){scope.options.clinical_depts=response.data})});var init=function(){scope.timetable_list=[],scope.selectedCalHeader=[],scope.selectedCalHeaderId=0,mdtTimetableService.byDoctor(scope.doctorId).then(function(response){for(var i=0;i<scope.options.timetable_dow.length;i++){scope.timetable_list.push({dow:scope.options.timetable_dow[i].code,data:[]}),"undefined"!=typeof response.data[i]&&(scope.timetable_list[i].doctor_id=response.data[i].doctor_id);for(var j=0;j<response.data.length;j++)response.data[j].day_of_Week===scope.options.timetable_dow[i].code&&(scope.timetable_list[i].data.push(response.data[j]),scope.timetable_list[i].cal_header_df_id=response.data[j].cal_header_df_id)}for(var i=0;i<scope.timetable_list.length;i++)if(0==scope.timetable_list[i].data.length)scope.timetable_list[i].data.push({from_time_display:"00:00",to_time_display:"00:00",isexists:!1});else for(var j=0;j<scope.timetable_list[i].data.length;j++)scope.timetable_list[i].data[j].from_time_display=ConfigService.convertToTimeString(scope.timetable_list[i].data[j].from_time),scope.timetable_list[i].data[j].to_time_display=ConfigService.convertToTimeString(scope.timetable_list[i].data[j].to_time),scope.timetable_list[i].data[j].isexists=!0})};init(),scope.clickInput=function(option){"add"===option.type?scope.timetable_list[option.pindex].data.push({from_time_display:"00:00",to_time_display:"00:00",isexists:!1}):"remove"===option.type&&scope.timetable_list[option.pindex].data.splice(option.index,1)},scope.clickInputCalHeader=function(option){"add"===option.type?scope.selectedCalHeader.push({week_ord_of_month:"2",site_id:"0",isexists:!1}):"remove"===option.type&&scope.selectedCalHeader.splice(option.index,1)},scope.saveCalHeader=function(){mdtTimetableService.addSite(scope.doctorId,scope.selectedCalHeaderId,scope.selectedCalHeader).then(function(response){toastr.success("Saving State Successful"),init()})},scope.saveTimetable=function(option){mdtTimetableService.add(scope.timetable_list[option.pindex],scope.doctorId).then(function(response){toastr.success("Saving Timetable Successful"),init()})},scope.saveNewTimetable=function(data,pindex){data.dow=scope.timetable_list[pindex].dow,mdtTimetableService.add(data,scope.doctorId).then(function(response){toastr.success("Saving Timetable Successful"),init()})},scope.showState=function(data){data.cal_header_df_id?(scope.selectedCalHeaderId=data.cal_header_df_id,scope.selectedCalHeader=[],mdtTimetableService.showWeek(scope.doctorId,data.cal_header_df_id).then(function(response){if(response.data.length>0){scope.selectedCalHeader=response.data;for(var i=0;i<scope.selectedCalHeader.length;i++)scope.selectedCalHeader[i].isexists=!0}else scope.selectedCalHeader.push({week_ord_of_month:0,site_id:0,isexists:!1})})):(scope.selectedCalHeader=[],scope.selectedCalHeader.push({week_ord_of_month:0,site_id:0,isexists:!1}))},scope.generate=function(){mdtTimetableService.generate(scope.selectedDoctor.doctor_id,scope.selectedDoctor.Appt_interval,scope.selectedDoctor.CLINICAL_DEPT_ID).then(function(response){toastr.success("Generate Timetable Successfully")})}}}});