angular.module("app.loggedIn.timetable",["app.loggedIn.timetable.include"]),angular.module("app.loggedIn.timetable.include",["app.loggedIn.timetable.directives.calendar","app.loggedIn.timetable.dialogs.addDay","app.loggedIn.timetable.dialogs.editDay","app.loggedIn.timetable.dialogs.addSite","app.loggedIn.timetable.model"]),angular.module("app.loggedIn.timetable.directives.calendar",[]).directive("timetableCalendar",function(TimetableModel,$modal,$stateParams,mdtDoctorService,sysServiceService,toastr){return{restrict:"EA",templateUrl:"modules/timetable/directives/templates/calendar.html",link:function(scope,elem,attrs){scope.weekDisplay={0:"Weekly",1:"Week 1",2:"Week 2",3:"Week 3",4:"Week 4"};var load=function(){TimetableModel.list({doctor_id:$stateParams.doctorId}).then(function(response){scope.timetable.list=response.data,scope.displayInRow={};for(var i=0;i<scope.timetable.list.length;i++){var item=scope.timetable.list[i];scope.displayInRow[item.day_of_week_value]||(scope.displayInRow[item.day_of_week_value]={value:item.cal_header_df_id,services:{}}),scope.displayInRow[item.day_of_week_value].services[item.service_id]||(scope.displayInRow[item.day_of_week_value].services[item.service_id]=item.cal_header_df_id)}scope.site.load()},function(error){})},siteLoad=function(){TimetableModel.siteList({doctor_id:$stateParams.doctorId}).then(function(response){var i=0;_.forEach(scope.timetable.list,function(timetable_row){scope.timetable.list[i].site=[],_.forEach(response.data,function(site_row){site_row.cal_header_df_id===timetable_row.cal_header_df_id&&scope.timetable.list[i].site.push(site_row)}),i++})},function(error){})},addDay=function(){var modalInstance=$modal.open({templateUrl:"modules/timetable/dialogs/templates/addDay.html",controller:"TimetableCalendarAddDayDialog",size:"lg",resolve:{services:function(){return scope.service.list},doctor:function(){return scope.doctor.item}}});modalInstance.result.then(function(status){"add"===status&&scope.timetable.load()})},doctorLoad=function(){mdtDoctorService.byId($stateParams.doctorId).then(function(response){scope.doctor.item=response.data,serviceLoad(response.data.CLINICAL_DEPT_ID)},function(error){})},serviceLoad=function(clinical_dept_id){sysServiceService.byClinicalDepartment(clinical_dept_id).then(function(response){scope.service.list=response.data})},addSite=function(row){var modalInstance=$modal.open({templateUrl:"modules/timetable/dialogs/templates/addSite.html",controller:"TimetableCalendarAddSiteDialog",size:"lg",resolve:{row:function(){return row},doctor:function(){return scope.doctor.item}}});modalInstance.result.then(function(status){"add"===status&&scope.timetable.load()})},saveTimetable=function(row){var postData=angular.copy(row);switch(postData.day_of_Week_code=null,postData.day_of_Week){case"Monday":postData.day_of_Week_code=1;break;case"Tuesday":postData.day_of_Week_code=2;break;case"Wednesday":postData.day_of_Week_code=3;break;case"Thursday":postData.day_of_Week_code=4;break;case"Friday":postData.day_of_Week_code=5;break;case"Saturday":postData.day_of_Week_code=6}postData.clinical_dept_id=scope.doctor.item.CLINICAL_DEPT_ID,postData.appt_interval=row.appt_interval,TimetableModel.createTimetable(postData).then(function(response){toastr.success("success"==response.status?"Timetable is created":"Create timetable fail.")},function(error){toastr.error("Create timetable fail.")})},editTimetable=function(row){$modal.open({templateUrl:"modules/timetable/dialogs/templates/editDay.html",controller:"TimetableCalendarEditDayDialog",size:"lg",resolve:{row:function(){return row},services:function(){return scope.service.list},doctor:function(){return scope.doctor.item}}}).result.then(function(response){"success"===response&&scope.timetable.load()})},openTimetable=function(row){row.clinical_dept_id=scope.doctor.item.CLINICAL_DEPT_ID;var modalInstance=$modal.open({templateUrl:"notifyToSaveTimetable",controller:function($scope,row,$modalInstance){$scope.bookedList=[],TimetableModel.beforeGenerateCalendar(row).then(function(data){"success"==data.status?$scope.bookedList=data.data:toastr.error("Error when check data.")},function(err){toastr.error("Error when check data.")}),$scope.ok=function(){$modalInstance.close(row)},$scope.cancel=function(){$modalInstance.dismiss("cancel")}},resolve:{row:function(){return row}}});modalInstance.result.then(function(row){row&&scope.timetable.saveTimetable(row)})},removeDay=function(row){var modalInstance=$modal.open({templateUrl:"notifyToRemoveDay",controller:function($scope,row,$modalInstance){$scope.ok=function(){$modalInstance.close(row)},$scope.cancel=function(){$modalInstance.dismiss("cancel")}},size:"sm",resolve:{row:function(){return row}}});modalInstance.result.then(function(row){row&&TimetableModel.remove(row).then(function(response){toastr.success("Remove Day Successfully"),scope.timetable.load()},function(error){})})},removeSite=function(id){var modalInstance=$modal.open({templateUrl:"notifyToRemoveSite",controller:function($scope,id,$modalInstance){$scope.ok=function(){$modalInstance.close(id)},$scope.cancel=function(){$modalInstance.dismiss("cancel")}},size:"sm",resolve:{id:function(){return id}}});modalInstance.result.then(function(id){id&&TimetableModel.siteRemove({id:id}).then(function(response){"success"==response.status?(toastr.success("Remove Successfully."),scope.timetable.load()):toastr.error("Remove fail.")},function(error){toastr.error("Remove fail.")})})};scope.timetable={load:function(){load()},dialog:{removeDay:function(row){removeDay(row)},openTimetable:function(row){openTimetable(row)},editTimetable:function(row){editTimetable(row)},addDay:function(){addDay()}},list:[],form:{day_of_Week:"",SERVICE_ID:null,from_time:"",to_time:"",from_date:null,to_date:null,description:""},saveTimetable:function(row){saveTimetable(row)}},scope.site={load:function(){siteLoad()},dialog:{addSite:function(row){addSite(row)},removeSite:function(id){removeSite(id)}}},scope.doctor={load:function(){doctorLoad()},item:{}},scope.service={list:[],load:function(){serviceLoad()}},scope.timetable.load(),scope.doctor.load(),scope.service.load()}}}),angular.module("app.loggedIn.timetable.dialogs.addDay",[]).controller("TimetableCalendarAddDayDialog",function($scope,$cookieStore,$stateParams,$modalInstance,services,doctor,TimetableModel,ConfigService,toastr){var user_id=$cookieStore.get("userInfo").id,day_of_week=[{value:"Monday"},{value:"Tuesday"},{value:"Wednesday"},{value:"Thursday"},{value:"Friday"},{value:"Saturday"}],save=function(){ConfigService.beforeSave($scope.timetable.errors),$scope.timetable.errors=[];var postData=angular.copy($scope.timetable.form);postData.Creation_date=postData.Last_update_date=moment().format("YYYY-MM-DD"),postData.Created_by=postData.Last_updated_by=user_id,postData.isenable=1,postData.from_date=ConfigService.convertToDB(postData.from_date),postData.to_date=ConfigService.convertToDB(postData.to_date),postData.from_time=ConfigService.convertToHHMM(postData.from_time),postData.to_time=ConfigService.convertToHHMM(postData.to_time),postData.doctor_id=$stateParams.doctorId,TimetableModel.add(postData).then(function(response){toastr.success("Added Successfully"),$modalInstance.close("add")},function(error){$scope.timetable.errors=angular.copy(error.data.errors),ConfigService.beforeError($scope.timetable.errors)})};$scope.timetable={options:{DAY_OF_WEEK:day_of_week,services:services},form:{day_of_Week:"",SERVICE_ID:null,from_time:"",to_time:"",from_date:null,to_date:null,description:"",appt_interval:doctor.Appt_interval},errors:[],save:function(){save()}}}),angular.module("app.loggedIn.timetable.dialogs.editDay",[]).controller("TimetableCalendarEditDayDialog",function($scope,$cookieStore,$stateParams,$modalInstance,services,doctor,row,TimetableModel,ConfigService,toastr){var user_id=$cookieStore.get("userInfo").id,day_of_week=[{value:"Monday"},{value:"Tuesday"},{value:"Wednesday"},{value:"Thursday"},{value:"Friday"},{value:"Saturday"}],save=function(){ConfigService.beforeSave($scope.timetable.errors),$scope.timetable.errors=[];var postData=angular.copy($scope.timetable.form);postData.Last_update_date=moment().format("YYYY-MM-DD"),postData.Created_by=postData.Last_updated_by=user_id,postData.isenable=1,postData.from_time=ConfigService.convertToHHMM(postData.from_time),postData.to_time=ConfigService.convertToHHMM(postData.to_time),postData.from_date=ConfigService.convertToDB(postData.from_date),postData.to_date=ConfigService.convertToDB(postData.to_date),postData.doctor_id=$stateParams.doctorId,TimetableModel.edit(postData).then(function(response){toastr.success("Edit Successfully"),$modalInstance.close("success")},function(error){$scope.timetable.errors=angular.copy(error.data.errors),ConfigService.beforeError($scope.timetable.errors)})},load=function(){TimetableModel.one({cal_header_df_id:row.cal_header_df_id}).then(function(response){angular.extend($scope.timetable.form,response.data),$scope.timetable.form.from_date=ConfigService.convertToDate($scope.timetable.form.from_date),$scope.timetable.form.to_date=ConfigService.convertToDate($scope.timetable.form.to_date),$scope.timetable.form.from_time=ConfigService.convertHHMMToInt($scope.timetable.form.from_time),$scope.timetable.form.to_time=ConfigService.convertHHMMToInt($scope.timetable.form.to_time),delete $scope.timetable.form.Creation_date},function(error){})};$scope.timetable={load:function(){load()},options:{DAY_OF_WEEK:day_of_week,services:services},form:{day_of_Week:"",service_id:null,from_time:"",to_time:"",from_date:null,to_date:null,description:"",appt_interval:doctor.Appt_interval},errors:[],save:function(){save()}},$scope.timetable.load()}),angular.module("app.loggedIn.timetable.dialogs.addSite",[]).controller("TimetableCalendarAddSiteDialog",function($scope,$cookieStore,$stateParams,$modalInstance,row,doctor,toastr,TimetableModel,ConfigService){var user_id=$cookieStore.get("userInfo").id,weeks=[{code:0,value:"Weekly"},{code:1,value:"Week 1"},{code:2,value:"Week 2"},{code:3,value:"Week 3"},{code:4,value:"Week 4"}],save=function(){ConfigService.beforeSave($scope.site.errors);var postData=angular.copy($scope.site.form);postData.Creation_date=postData.Last_update_date=moment().format("YYYY-MM-DD"),postData.Created_by=postData.Last_updated_by=user_id,postData.isenable=1,postData.doctor_id=$stateParams.doctorId,postData.cal_header_df_id=row.cal_header_df_id,TimetableModel.siteAdd(postData).then(function(response){toastr.success("Added Successfully"),$modalInstance.close("add")},function(error){$scope.site.errors=angular.copy(error.data.errors),ConfigService.beforeError($scope.site.errors)})};$scope.site={options:{weeks:weeks,sites:[]},form:{cal_header_df_id:null,week_ord_of_month:null,site_id:null,description:""},errors:[],save:function(){save()}};var loadOptions=function(){TimetableModel.redimedsiteList({CLINICAL_DEPT_ID:doctor.CLINICAL_DEPT_ID}).then(function(response){$scope.site.options.sites=response.data},function(error){})};loadOptions()}),angular.module("app.loggedIn.timetable.model",[]).factory("TimetableModel",function(Restangular){var instanceService={},appApi=Restangular.all("api/meditek/v1/timetable"),redimedApi=Restangular.all("api/meditek/v1/redimedsite");return instanceService.list=function(data){var detailApi=appApi.all("list");return detailApi.post({data:data})},instanceService.one=function(data){var detailApi=appApi.all("one");return detailApi.post({data:data})},instanceService.siteList=function(data){var detailApi=appApi.all("siteList");return detailApi.post({data:data})},instanceService.siteAdd=function(data){var detailApi=appApi.all("siteAdd");return detailApi.post({data:data})},instanceService.siteRemove=function(data){var detailApi=appApi.all("siteRemove");return detailApi.post({data:data})},instanceService.remove=function(data){var detailApi=appApi.all("remove");return detailApi.post({data:data})},instanceService.add=function(data){var detailApi=appApi.all("add");return detailApi.post({data:data})},instanceService.edit=function(data){var detailApi=appApi.all("edit");return detailApi.post({data:data})},instanceService.redimedsiteList=function(data){var detailApi=redimedApi.all("list");return detailApi.post({data:data})},instanceService.createTimetable=function(data){var detailApi=appApi.all("createTimetable");return detailApi.post({data:data})},instanceService.beforeGenerateCalendar=function(data){var detailApi=appApi.all("beforeGenerateCalendar");return detailApi.post({data:data})},instanceService.deleteAllCalendarInDate=function(data){var detailApi=appApi.all("deleteAllCalendarInDate");return detailApi.post({data:data})},instanceService.beforeDeleteAllCalendarInDate=function(data){var detailApi=appApi.all("beforeDeleteAllCalendarInDate");return detailApi.post({data:data})},instanceService.deleteSelectedCalendar=function(calId){var detailApi=appApi.all("deleteSelectedCalendar");return detailApi.post({calId:calId})},instanceService.beforeDeleteSelectedCalendar=function(calId){var detailApi=appApi.all("beforeDeleteSelectedCalendar");return detailApi.post({calId:calId})},instanceService.getAllCalendarInDate=function(data){var detailApi=appApi.all("getAllCalendarInDate");return detailApi.post({data:data})},instanceService.updateServiceInDate=function(data){var detailApi=appApi.all("updateServiceInDate");return detailApi.post({data:data})},instanceService});